module BigStepErased where

open import Data.Nat
open import Data.Unit using (âŠ¤; tt)
open import Data.Bool using (true; false) renaming (Bool to ğ”¹)
open import Data.List hiding ([_])
open import Data.Product using (_Ã—_; âˆƒ-syntax; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Maybe
open import Relation.Nullary using (Â¬_; Dec; yes; no)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl)

open import Utils
open import Heap
open import Types
open import TypeBasedCast
open import CC

infix 2 _âˆ£_âŠ¢_â‡“â‚‘_âˆ£_
data _âˆ£_âŠ¢_â‡“â‚‘_âˆ£_ : HalfHeap â†’ StaticLabel â†’ (M V : Term) â†’ HalfHeap â†’ Set

â‡“â‚‘-value : âˆ€ {Î¼ Î¼â€² pc M V} â†’ Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â€² â†’ Value V

{- runs on erased terms -}
data _âˆ£_âŠ¢_â‡“â‚‘_âˆ£_ where

  â‡“â‚‘-val : âˆ€ {Î¼ pc V}
    â†’ Value V
      --------------------------- Value
    â†’ Î¼ âˆ£ pc âŠ¢ V â‡“â‚‘ V âˆ£ Î¼

  â‡“â‚‘-app : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ Î¼â‚ƒ pc pcâ€² L M N V W A}
    â†’ Î¼  âˆ£ pc âŠ¢ L       â‡“â‚‘ Æ›[ pcâ€² ] A Ë™ N of low âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ M       â‡“â‚‘ V âˆ£ Î¼â‚‚
    â†’ Î¼â‚‚ âˆ£ pc âŠ¢ N [ V ] â‡“â‚‘ W âˆ£ Î¼â‚ƒ
      ---------------------------------------- Application
    â†’ Î¼  âˆ£ pc âŠ¢ L Â· M   â‡“â‚‘ W âˆ£ Î¼â‚ƒ

  â‡“â‚‘-app-â— : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M V}
    â†’ Î¼  âˆ£ pc âŠ¢ L       â‡“â‚‘ â— âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ M       â‡“â‚‘ V  âˆ£ Î¼â‚‚
      ---------------------------------------- Applicationâ—
    â†’ Î¼  âˆ£ pc âŠ¢ L Â· M   â‡“â‚‘ â— âˆ£ Î¼â‚‚

  â‡“â‚‘-if-true : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M N V A}
    â†’ Î¼  âˆ£ pc âŠ¢ L          â‡“â‚‘ $ true of low âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ M          â‡“â‚‘ V âˆ£ Î¼â‚‚
      ------------------------------------------------ IfTrue
    â†’ Î¼  âˆ£ pc âŠ¢ if L A M N â‡“â‚‘ V âˆ£ Î¼â‚‚

  â‡“â‚‘-if-false : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M N V A}
    â†’ Î¼  âˆ£ pc âŠ¢ L          â‡“â‚‘ $ false of low âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ N          â‡“â‚‘ V âˆ£ Î¼â‚‚
      ------------------------------------------------ IfFalse
    â†’ Î¼  âˆ£ pc âŠ¢ if L A M N â‡“â‚‘ V âˆ£ Î¼â‚‚

  â‡“â‚‘-if-â— : âˆ€ {Î¼ Î¼â‚ pc L M N A}
    â†’ Î¼  âˆ£ pc âŠ¢ L          â‡“â‚‘ â— âˆ£ Î¼â‚
      ------------------------------------------------ Ifâ—
    â†’ Î¼  âˆ£ pc âŠ¢ if L A M N â‡“â‚‘ â— âˆ£ Î¼â‚

  â‡“â‚‘-let : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc M N V W}
    â†’ Î¼  âˆ£ pc âŠ¢ M        â‡“â‚‘ V âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ N [ V ]  â‡“â‚‘ W âˆ£ Î¼â‚‚
      ----------------------------------------- Let
    â†’ Î¼  âˆ£ pc âŠ¢ `let M N â‡“â‚‘ W âˆ£ Î¼â‚‚

  â‡“â‚‘-ref? : âˆ€ {Î¼ Î¼â‚ pc M V n}
    â†’ (â‡“V : Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚)
    â†’ n â‰¡ length Î¼â‚
    â†’ pc â‰¼ low
      -------------------------------------------------------------------------------------- RefNSU
    â†’ Î¼ âˆ£ pc âŠ¢ ref?[ low ] M â‡“â‚‘ addr (a[ low ] n) of low âˆ£ âŸ¨ n , V & â‡“â‚‘-value â‡“V âŸ© âˆ· Î¼â‚

  â‡“â‚‘-ref?-â— : âˆ€ {Î¼ Î¼â‚ pc M V}
    â†’ (â‡“V : Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚)
      -------------------------------------------------------------------------------------- RefNSUâ—
    â†’ Î¼ âˆ£ pc âŠ¢ ref?[ high ] M â‡“â‚‘ â— âˆ£ Î¼â‚ {- skip creation -}

  â‡“â‚‘-ref : âˆ€ {Î¼ Î¼â‚ pc M V n}
    â†’ (â‡“V : Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚)
    â†’ n â‰¡ length Î¼â‚
      -------------------------------------------------------------------------------------- Ref
    â†’ Î¼ âˆ£ pc âŠ¢ ref[ low ] M â‡“â‚‘ addr (a[ low ] n) of low âˆ£ âŸ¨ n , V & â‡“â‚‘-value â‡“V âŸ© âˆ· Î¼â‚

  â‡“â‚‘-ref-â— : âˆ€ {Î¼ Î¼â‚ pc M V}
    â†’ (â‡“V : Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚)
      -------------------------------------------------------------------------------------- Refâ—
    â†’ Î¼ âˆ£ pc âŠ¢ ref[ high ] M â‡“â‚‘ â— âˆ£ Î¼â‚ {- skip creation -}

  â‡“â‚‘-deref : âˆ€ {Î¼ Î¼â‚ pc M V v n}
    â†’ Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ addr (a[ low ] n) of low âˆ£ Î¼â‚
    â†’ find _â‰Ÿ_ Î¼â‚ n â‰¡ just (V & v)
      ---------------------------------- Deref
    â†’ Î¼ âˆ£ pc âŠ¢ ! M â‡“â‚‘ V âˆ£ Î¼â‚

  â‡“â‚‘-deref-â— : âˆ€ {Î¼ Î¼â‚ pc M}
    â†’ Î¼ âˆ£ pc âŠ¢ M   â‡“â‚‘ â— âˆ£ Î¼â‚
      ----------------------------------------- Derefâ—
    â†’ Î¼ âˆ£ pc âŠ¢ ! M â‡“â‚‘ â— âˆ£ Î¼â‚

  â‡“â‚‘-assign? : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M V n}
    â†’ Î¼  âˆ£ pc âŠ¢ L      â‡“â‚‘ addr (a[ low ] n) of low âˆ£ Î¼â‚
    â†’ (â‡“V : Î¼â‚ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚‚)
    â†’ pc â‰¼ low
      -------------------------------------------------------------------------- AssignNSU
    â†’ Î¼ âˆ£ pc âŠ¢ L :=? M â‡“â‚‘ $ tt of low âˆ£ âŸ¨ n , V & â‡“â‚‘-value â‡“V âŸ© âˆ· Î¼â‚‚

  â‡“â‚‘-assign?-â— : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M V}
    â†’ Î¼  âˆ£ pc âŠ¢ L       â‡“â‚‘ â— âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ M       â‡“â‚‘ V  âˆ£ Î¼â‚‚
      -------------------------------------------------------- AssignNSUâ—
    â†’ Î¼  âˆ£ pc âŠ¢ L :=? M â‡“â‚‘ $ tt of low âˆ£ Î¼â‚‚ {- skip assignment -}

  â‡“â‚‘-assign : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M V n}
    â†’ Î¼  âˆ£ pc âŠ¢ L      â‡“â‚‘ addr (a[ low ] n) of low âˆ£ Î¼â‚
    â†’ (â‡“V : Î¼â‚ âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚‚)
      -------------------------------------------------------------------------- Assign
    â†’ Î¼  âˆ£ pc âŠ¢ L := M â‡“â‚‘ $ tt of low âˆ£ âŸ¨ n , V & â‡“â‚‘-value â‡“V âŸ© âˆ· Î¼â‚‚

  â‡“â‚‘-assign-â— : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc L M V}
    â†’ Î¼  âˆ£ pc âŠ¢ L      â‡“â‚‘ â— âˆ£ Î¼â‚
    â†’ Î¼â‚ âˆ£ pc âŠ¢ M      â‡“â‚‘ V  âˆ£ Î¼â‚‚
      -------------------------------------------------------- Assignâ—
    â†’ Î¼  âˆ£ pc âŠ¢ L := M â‡“â‚‘ $ tt of low âˆ£ Î¼â‚‚ {- skip assignment -}


â‡“â‚‘-value (â‡“â‚‘-val v) = v
â‡“â‚‘-value (â‡“â‚‘-app _ _ â‡“V) = â‡“â‚‘-value â‡“V
â‡“â‚‘-value (â‡“â‚‘-app-â— _ _) = V-â—
â‡“â‚‘-value (â‡“â‚‘-if-true  _ â‡“V) = â‡“â‚‘-value â‡“V
â‡“â‚‘-value (â‡“â‚‘-if-false _ â‡“V) = â‡“â‚‘-value â‡“V
â‡“â‚‘-value (â‡“â‚‘-if-â— â‡“V) = V-â—
â‡“â‚‘-value (â‡“â‚‘-let _ â‡“V) = â‡“â‚‘-value â‡“V
â‡“â‚‘-value (â‡“â‚‘-ref? _ _ _) = V-addr
â‡“â‚‘-value (â‡“â‚‘-ref?-â— _) = V-â—
â‡“â‚‘-value (â‡“â‚‘-ref    _ _) = V-addr
â‡“â‚‘-value (â‡“â‚‘-ref-â— _) = V-â—
â‡“â‚‘-value (â‡“â‚‘-deref {v = v} _ _) = v
â‡“â‚‘-value (â‡“â‚‘-deref-â—        _) = V-â—
â‡“â‚‘-value (â‡“â‚‘-assign?     _ _ _) = V-const
â‡“â‚‘-value (â‡“â‚‘-assign?-â—    _ _) = V-const
â‡“â‚‘-value (â‡“â‚‘-assign        _ _) = V-const
â‡“â‚‘-value (â‡“â‚‘-assign-â—     _ _) = V-const


Vâ‡“â‚‘V : âˆ€ {Î¼ Î¼â€² pc V W}
  â†’ Î¼ âˆ£ pc âŠ¢ V â‡“â‚‘ W âˆ£ Î¼â€²
  â†’ Value V
    ---------------------------
  â†’ V â‰¡ W Ã— Î¼ â‰¡ Î¼â€²
Vâ‡“â‚‘V (â‡“â‚‘-val _) v = âŸ¨ refl , refl âŸ©


{- â‡“â‚‘ is transitive -}
â‡“â‚‘-trans : âˆ€ {Î¼ Î¼â‚ Î¼â‚‚ pc M V W}
  â†’ Î¼  âˆ£ pc âŠ¢ M â‡“â‚‘ V âˆ£ Î¼â‚
  â†’ Î¼â‚ âˆ£ pc âŠ¢ V â‡“â‚‘ W âˆ£ Î¼â‚‚
    ---------------------------
  â†’ Î¼  âˆ£ pc âŠ¢ M â‡“â‚‘ W âˆ£ Î¼â‚‚
â‡“â‚‘-trans Mâ‡“V Vâ‡“W with Vâ‡“â‚‘V Vâ‡“W (â‡“â‚‘-value Mâ‡“V)
... | âŸ¨ refl , refl âŸ© = Mâ‡“V


{- a few inversion lemmas about â‡“â‚‘ -}
â‡“â‚‘-app-â—-inv : âˆ€ {Î¼ Î¼â€² pc V W}
  â†’ Î¼ âˆ£ pc âŠ¢ â— Â· V â‡“â‚‘ W âˆ£ Î¼â€²
  â†’ Value V
    ---------------------------
  â†’ W â‰¡ â— Ã— Î¼ â‰¡ Î¼â€²
â‡“â‚‘-app-â—-inv (â‡“â‚‘-app-â— â—â‡“â— Vâ‡“V) v
  with Vâ‡“â‚‘V â—â‡“â— V-â— | Vâ‡“â‚‘V Vâ‡“V v
... | âŸ¨ refl , refl âŸ© | âŸ¨ refl , refl âŸ© = âŸ¨ refl , refl âŸ©

â‡“â‚‘-app-inv : âˆ€ {Î¼ Î¼â€² pc pcâ€² N V W A}
  â†’ Î¼ âˆ£ pc âŠ¢ Æ›[ pcâ€² ] A Ë™ N of low Â· V â‡“â‚‘ W âˆ£ Î¼â€²
  â†’ Value V
    ------------------------------------------
  â†’ Î¼ âˆ£ pc âŠ¢ N [ V ] â‡“â‚‘ W âˆ£ Î¼â€²
â‡“â‚‘-app-inv (â‡“â‚‘-app Æ›Nâ‡“Æ›N Vâ‡“V N[V]â‡“W) v
  with Vâ‡“â‚‘V Æ›Nâ‡“Æ›N V-Æ› | Vâ‡“â‚‘V Vâ‡“V v
... | âŸ¨ refl , refl âŸ© | âŸ¨ refl , refl âŸ© = N[V]â‡“W

â‡“â‚‘-assign-â—-inv : âˆ€ {Î¼ Î¼â€² pc M V}
  â†’ Î¼ âˆ£ pc âŠ¢ â— := M â‡“â‚‘ V âˆ£ Î¼â€²
    ---------------------------
  â†’ V â‰¡ $ tt of low Ã— âˆƒ[ W ] (Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ W âˆ£ Î¼â€²)
â‡“â‚‘-assign-â—-inv (â‡“â‚‘-assign-â— â—â‡“â— Mâ‡“W)
  with Vâ‡“â‚‘V â—â‡“â— V-â—
... | âŸ¨ refl , refl âŸ© = âŸ¨ refl , _ , Mâ‡“W âŸ©

â‡“â‚‘-assign-inv : âˆ€ {Î¼ Î¼â€² pc M V n}
  â†’ Î¼ âˆ£ pc âŠ¢ (addr a[ low ] n of low) := M â‡“â‚‘ V âˆ£ Î¼â€²
    -----------------------------------------------------------
  â†’ V â‰¡ $ tt of low Ã— âˆƒ[ W ] âˆƒ[ w ] âˆƒ[ Î¼â€³ ] (Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ W âˆ£ Î¼â€³) Ã— (Î¼â€² â‰¡ âŸ¨ n , W & w âŸ© âˆ· Î¼â€³)
â‡“â‚‘-assign-inv (â‡“â‚‘-assign aâ‡“a Mâ‡“W)
  with Vâ‡“â‚‘V aâ‡“a V-addr
... | âŸ¨ refl , refl âŸ© = âŸ¨ refl , _ , â‡“â‚‘-value Mâ‡“W , _ , Mâ‡“W , refl âŸ©

â‡“â‚‘-assign?-â—-inv : âˆ€ {Î¼ Î¼â€² pc M V}
  â†’ Î¼ âˆ£ pc âŠ¢ â— :=? M â‡“â‚‘ V âˆ£ Î¼â€²
    ---------------------------
  â†’ V â‰¡ $ tt of low Ã— âˆƒ[ W ] (Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ W âˆ£ Î¼â€²)
â‡“â‚‘-assign?-â—-inv (â‡“â‚‘-assign?-â— â—â‡“â— Mâ‡“W)
  with Vâ‡“â‚‘V â—â‡“â— V-â—
... | âŸ¨ refl , refl âŸ© = âŸ¨ refl , _ , Mâ‡“W âŸ©

â‡“â‚‘-assign?-inv : âˆ€ {Î¼ Î¼â€² pc M V n}
  â†’ Î¼ âˆ£ pc âŠ¢ (addr a[ low ] n of low) :=? M â‡“â‚‘ V âˆ£ Î¼â€²
    -----------------------------------------------------------
  â†’ V â‰¡ $ tt of low Ã— pc â‰¼ low Ã— âˆƒ[ W ] âˆƒ[ w ] âˆƒ[ Î¼â€³ ] (Î¼ âˆ£ pc âŠ¢ M â‡“â‚‘ W âˆ£ Î¼â€³) Ã— (Î¼â€² â‰¡ âŸ¨ n , W & w âŸ© âˆ· Î¼â€³)
â‡“â‚‘-assign?-inv (â‡“â‚‘-assign? aâ‡“a Mâ‡“W pcâ‰¼low)
  with Vâ‡“â‚‘V aâ‡“a V-addr
... | âŸ¨ refl , refl âŸ© = âŸ¨ refl , pcâ‰¼low , _ , â‡“â‚‘-value Mâ‡“W , _ , Mâ‡“W , refl âŸ©

â‡“â‚‘-deref-â—-inv : âˆ€ {Î¼ Î¼â€² pc V}
  â†’ Î¼ âˆ£ pc âŠ¢ ! â— â‡“â‚‘ V âˆ£ Î¼â€²
    ---------------------------
  â†’ V â‰¡ â— Ã— Î¼ â‰¡ Î¼â€²
â‡“â‚‘-deref-â—-inv (â‡“â‚‘-deref-â— â—â‡“â—) with Vâ‡“â‚‘V â—â‡“â— V-â—
... | âŸ¨ refl , refl âŸ© = âŸ¨ refl , refl âŸ©

â‡“â‚‘-deref-inv : âˆ€ {Î¼ Î¼â€² pc V n}
  â†’ Î¼ âˆ£ pc âŠ¢ ! (addr a[ low ] n of low) â‡“â‚‘ V âˆ£ Î¼â€²
    --------------------------------------------------
  â†’ (âˆƒ[ v ] find _â‰Ÿ_ Î¼ n â‰¡ just (V & v)) Ã— Î¼ â‰¡ Î¼â€²
â‡“â‚‘-deref-inv (â‡“â‚‘-deref {v = v} aâ‡“a eq) with Vâ‡“â‚‘V aâ‡“a V-addr
... | âŸ¨ refl , refl âŸ© = âŸ¨ âŸ¨ v , eq âŸ© , refl âŸ©
