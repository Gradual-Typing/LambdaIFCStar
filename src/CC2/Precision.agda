{- Precision relation of CC2 -}

open import Common.Types

module CC2.Precision where

open import Data.Nat
open import Data.Unit using (âŠ¤; tt)
open import Data.Bool using (true; false) renaming (Bool to ğ”¹)
open import Data.List
open import Data.Product using (_Ã—_; âˆƒ-syntax; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Data.Maybe
open import Relation.Nullary using (Â¬_; Dec; yes; no)
open import Relation.Nullary.Negation using (contradiction)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; subst; substâ‚‚; sym)
open import Function using (case_of_)

open import Syntax hiding (_â¨Ÿ_)
open import Common.Utils
open import CC2.Statics
open import Memory.Heap Term Value hiding (Addr; aâŸ¦_âŸ§_)
open import Memory.HeapContext
open import CoercionExpr.Precision
  renaming (precâ†’âŠ‘ to cexpr-precâ†’âŠ‘;
            âŠ¢l_âŠ‘_ to âŠ¢â‚—_âŠ‘_; âŠ¢r_âŠ‘_ to âŠ¢áµ£_âŠ‘_)
open import CoercionExpr.SyntacComp renaming (_â¨Ÿ_ to _âŠ¹âŠ¹_)


data _âŠ‘*_ : (Î“ Î“â€² : Context) â†’ Set where

  âŠ‘*-âˆ… : [] âŠ‘* []

  âŠ‘*-âˆ· : âˆ€ {Î“ Î“â€² A Aâ€²} â†’ A âŠ‘ Aâ€² â†’ Î“ âŠ‘* Î“â€² â†’ (A âˆ· Î“) âŠ‘* (Aâ€² âˆ· Î“â€²)


âŠ‘*â†’âŠ‘ : âˆ€ {Î“ Î“â€² A Aâ€² x} â†’ Î“ âŠ‘* Î“â€² â†’ Î“ âˆ‹ x â¦‚ A â†’ Î“â€² âˆ‹ x â¦‚ Aâ€² â†’ A âŠ‘ Aâ€²
âŠ‘*â†’âŠ‘ {x = 0}     (âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€²) refl refl = AâŠ‘Aâ€²
âŠ‘*â†’âŠ‘ {x = suc x} (âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€²) Î“âˆ‹x  Î“â€²âˆ‹x = âŠ‘*â†’âŠ‘ Î“âŠ‘Î“â€² Î“âˆ‹x Î“â€²âˆ‹x


data _âŠ‘â‚•_ : (Î£ Î£â€² : HalfHeapContext) â†’ Set where

  âŠ‘-âˆ… : [] âŠ‘â‚• []

  âŠ‘-âˆ· : âˆ€ {Î£ Î£â€² T Tâ€² n} â†’ T âŠ‘áµ£ Tâ€² â†’ Î£ âŠ‘â‚• Î£â€² â†’ (âŸ¨ n , T âŸ© âˆ· Î£) âŠ‘â‚• (âŸ¨ n , Tâ€² âŸ© âˆ· Î£â€²)

_âŠ‘â‚˜_ : (Î£ Î£â€² : HeapContext) â†’ Set
âŸ¨ Î£á´¸ , Î£á´´ âŸ© âŠ‘â‚˜ âŸ¨ Î£á´¸â€² , Î£á´´â€² âŸ© = (Î£á´¸ âŠ‘â‚• Î£á´¸â€²) Ã— (Î£á´´ âŠ‘â‚• Î£á´´â€²)

âŠ‘â‚•â†’âŠ‘ : âˆ€ {Î£ Î£â€² T Tâ€² n}
  â†’ Î£ âŠ‘â‚• Î£â€²
  â†’ find _â‰Ÿ_ Î£  n â‰¡ just T
  â†’ find _â‰Ÿ_ Î£â€² n â‰¡ just Tâ€²
  â†’ T âŠ‘áµ£ Tâ€²
âŠ‘â‚•â†’âŠ‘ {âŸ¨ nâ‚€ , T âŸ© âˆ· _} {âŸ¨ nâ‚€ , Tâ€² âŸ© âˆ· _} {n = n} (âŠ‘-âˆ· TâŠ‘Tâ€² Î£âŠ‘Î£â€²) eq eqâ€²
  with n â‰Ÿ nâ‚€
... | no _ = âŠ‘â‚•â†’âŠ‘ Î£âŠ‘Î£â€² eq eqâ€²
... | yes refl with eq | eqâ€²
... | refl | refl = TâŠ‘Tâ€²

âŠ‘â‚˜â†’âŠ‘ : âˆ€ {Î£ Î£â€² T Tâ€² n â„“Ì‚}
  â†’ Î£ âŠ‘â‚˜ Î£â€²
  â†’ let a = aâŸ¦ â„“Ì‚ âŸ§ n in
     lookup-Î£ Î£  a â‰¡ just T
  â†’ lookup-Î£ Î£â€² a â‰¡ just Tâ€²
  â†’ T âŠ‘áµ£ Tâ€²
âŠ‘â‚˜â†’âŠ‘ {â„“Ì‚ = low}  âŸ¨ Î£á´¸âŠ‘ , _ âŸ© Î£aâ‰¡T Î£â€²aâ‰¡Tâ€² = âŠ‘â‚•â†’âŠ‘ Î£á´¸âŠ‘ Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²
âŠ‘â‚˜â†’âŠ‘ {â„“Ì‚ = high} âŸ¨ _ , Î£á´´âŠ‘ âŸ© Î£aâ‰¡T Î£â€²aâ‰¡Tâ€² = âŠ‘â‚•â†’âŠ‘ Î£á´´âŠ‘ Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²


infix 4 âŸ¨_âŸ©âŠ‘âŸ¨_âŸ©
infix 4 âŸ¨_âŸ©âŠ‘_
infix 4 _âŠ‘âŸ¨_âŸ©

data âŸ¨_âŸ©âŠ‘âŸ¨_âŸ© : âˆ€ {A Aâ€² B Bâ€²} â†’ Cast A â‡’ B â†’ Cast Aâ€² â‡’ Bâ€² â†’ Set where

  âŠ‘-base : âˆ€ {Î¹ gâ‚ gâ‚â€² gâ‚‚ gâ‚‚â€²} {cÌ… : CExpr gâ‚ â‡’ gâ‚‚} {cÌ…â€² : CExpr gâ‚â€² â‡’ gâ‚‚â€²}
    â†’ âŠ¢ cÌ… âŠ‘ cÌ…â€²
      --------------------------------------------------------
    â†’ âŸ¨ cast (Castáµ£_â‡’_.id Î¹) cÌ… âŸ©âŠ‘âŸ¨ cast (Castáµ£_â‡’_.id Î¹) cÌ…â€² âŸ©

  âŠ‘-ref : âˆ€ {A Aâ€² B Bâ€² gâ‚ gâ‚â€² gâ‚‚ gâ‚‚â€²} {c : Cast B â‡’ A} {câ€² : Cast Bâ€² â‡’ Aâ€²}
            {d : Cast A â‡’ B} {dâ€² : Cast Aâ€² â‡’ Bâ€²}
            {cÌ… : CExpr gâ‚ â‡’ gâ‚‚} {cÌ…â€² : CExpr gâ‚â€² â‡’ gâ‚‚â€²}
    â†’ âŸ¨ c âŸ©âŠ‘âŸ¨ câ€² âŸ©
    â†’ âŸ¨ d âŸ©âŠ‘âŸ¨ dâ€² âŸ©
    â†’ âŠ¢ cÌ… âŠ‘ cÌ…â€²
      --------------------------------------------------------
    â†’ âŸ¨ cast (ref c d) cÌ… âŸ©âŠ‘âŸ¨ cast (ref câ€² dâ€²) cÌ…â€² âŸ©

  âŠ‘-fun : âˆ€ {A Aâ€² B Bâ€² C Câ€² D Dâ€² gcâ‚ gcâ‚â€² gcâ‚‚ gcâ‚‚â€² gâ‚ gâ‚â€² gâ‚‚ gâ‚‚â€²}
            {c : Cast C â‡’ A} {câ€² : Cast Câ€² â‡’ Aâ€²}
            {d : Cast B â‡’ D} {dâ€² : Cast Bâ€² â‡’ Dâ€²}
            {dÌ… : CExpr gcâ‚‚ â‡’ gcâ‚} {dÌ…â€² : CExpr gcâ‚‚â€² â‡’ gcâ‚â€²}
            {cÌ… : CExpr gâ‚ â‡’ gâ‚‚} {cÌ…â€² : CExpr gâ‚â€² â‡’ gâ‚‚â€²}
    â†’ âŠ¢ dÌ… âŠ‘ dÌ…â€²
    â†’ âŸ¨ c âŸ©âŠ‘âŸ¨ câ€² âŸ©
    â†’ âŸ¨ d âŸ©âŠ‘âŸ¨ dâ€² âŸ©
    â†’ âŠ¢ cÌ… âŠ‘ cÌ…â€²
      --------------------------------------------------------
    â†’ âŸ¨ cast (fun dÌ… c d) cÌ… âŸ©âŠ‘âŸ¨ cast (fun dÌ…â€² câ€² dâ€²) cÌ…â€² âŸ©


data âŸ¨_âŸ©âŠ‘_ : âˆ€ {A B} â†’ Cast A â‡’ B â†’ (Aâ€² : Type) â†’ Set where

  âŠ‘-base : âˆ€ {Î¹ gâ‚ gâ‚‚ gâ€²} {cÌ… : CExpr gâ‚ â‡’ gâ‚‚}
    â†’ âŠ¢â‚— cÌ… âŠ‘ gâ€²
      --------------------------------------------------------
    â†’ âŸ¨ cast (Castáµ£_â‡’_.id Î¹) cÌ… âŸ©âŠ‘ ` Î¹ of gâ€²

  âŠ‘-ref : âˆ€ {A Aâ€² B gâ‚ gâ‚‚ gâ€²} {c : Cast B â‡’ A} {d : Cast A â‡’ B}
            {cÌ… : CExpr gâ‚ â‡’ gâ‚‚}
    â†’ âŸ¨ c âŸ©âŠ‘ Aâ€²
    â†’ âŸ¨ d âŸ©âŠ‘  Aâ€²
    â†’ âŠ¢â‚— cÌ… âŠ‘ gâ€²
      --------------------------------------------------------
    â†’ âŸ¨ cast (ref c d) cÌ… âŸ©âŠ‘ Ref Aâ€² of gâ€²

  âŠ‘-fun : âˆ€ {A Aâ€² B Bâ€² C D gcâ‚ gcâ‚‚ gcâ€² gâ‚ gâ‚‚ gâ€²}
            {c : Cast C â‡’ A} {d : Cast B â‡’ D}
            {dÌ… : CExpr gcâ‚‚ â‡’ gcâ‚} {cÌ… : CExpr gâ‚ â‡’ gâ‚‚}
    â†’ âŠ¢â‚— dÌ… âŠ‘ gcâ€²
    â†’ âŸ¨ c âŸ©âŠ‘ Aâ€²
    â†’ âŸ¨ d âŸ©âŠ‘ Bâ€²
    â†’ âŠ¢â‚— cÌ… âŠ‘ gâ€²
      --------------------------------------------------------
    â†’ âŸ¨ cast (fun dÌ… c d) cÌ… âŸ©âŠ‘ âŸ¦ gcâ€² âŸ§ Aâ€² â‡’ Bâ€² of gâ€²


data _âŠ‘âŸ¨_âŸ© : âˆ€ {Aâ€² Bâ€²} â†’ (A : Type) â†’ Cast Aâ€² â‡’ Bâ€² â†’ Set where

  âŠ‘-base : âˆ€ {Î¹ g gâ‚â€² gâ‚‚â€²} {cÌ…â€² : CExpr gâ‚â€² â‡’ gâ‚‚â€²}
    â†’ âŠ¢áµ£ g âŠ‘ cÌ…â€²
      --------------------------------------------------------
    â†’ ` Î¹ of g âŠ‘âŸ¨ cast (Castáµ£_â‡’_.id Î¹) cÌ…â€² âŸ©

  âŠ‘-ref : âˆ€ {A Aâ€² Bâ€² g gâ‚â€² gâ‚‚â€²} {câ€² : Cast Bâ€² â‡’ Aâ€²} {dâ€² : Cast Aâ€² â‡’ Bâ€²}
            {cÌ…â€² : CExpr gâ‚â€² â‡’ gâ‚‚â€²}
    â†’ A âŠ‘âŸ¨ câ€² âŸ©
    â†’ A âŠ‘âŸ¨ dâ€² âŸ©
    â†’ âŠ¢áµ£ g âŠ‘ cÌ…â€²
      --------------------------------------------------------
    â†’ Ref A of g âŠ‘âŸ¨ cast (ref câ€² dâ€²) cÌ…â€² âŸ©

  âŠ‘-fun : âˆ€ {A Aâ€² B Bâ€² Câ€² Dâ€² gc gcâ‚â€² gcâ‚‚â€² g gâ‚â€² gâ‚‚â€²}
            {câ€² : Cast Câ€² â‡’ Aâ€²} {dâ€² : Cast Bâ€² â‡’ Dâ€²}
            {dÌ…â€² : CExpr gcâ‚‚â€² â‡’ gcâ‚â€²} {cÌ…â€² : CExpr gâ‚â€² â‡’ gâ‚‚â€²}
    â†’ âŠ¢áµ£ gc âŠ‘ dÌ…â€²
    â†’ A âŠ‘âŸ¨ câ€² âŸ©
    â†’ B âŠ‘âŸ¨ dâ€² âŸ©
    â†’ âŠ¢áµ£ g âŠ‘ cÌ…â€²
      --------------------------------------------------------
    â†’ âŸ¦ gc âŸ§ A â‡’ B of g âŠ‘âŸ¨ cast (fun dÌ…â€² câ€² dâ€²) cÌ…â€² âŸ©


coercion-precâ†’âŠ‘ : âˆ€ {A Aâ€² B Bâ€²} {c : Cast A â‡’ B} {d : Cast Aâ€² â‡’ Bâ€²}
  â†’ âŸ¨ c âŸ©âŠ‘âŸ¨ d âŸ©
  â†’ A âŠ‘ Aâ€² Ã— B âŠ‘ Bâ€²
coercion-precâ†’âŠ‘ (âŠ‘-base cÌ…âŠ‘cÌ…â€²) =
  let âŸ¨ gâ‚âŠ‘gâ‚â€² , gâ‚‚âŠ‘gâ‚‚â€² âŸ© = cexpr-precâ†’âŠ‘ _ _ cÌ…âŠ‘cÌ…â€² in
  âŸ¨ âŠ‘-ty gâ‚âŠ‘gâ‚â€² âŠ‘-Î¹ , âŠ‘-ty gâ‚‚âŠ‘gâ‚‚â€² âŠ‘-Î¹ âŸ©
coercion-precâ†’âŠ‘ (âŠ‘-ref câŠ‘câ€² dâŠ‘dâ€² cÌ…âŠ‘cÌ…â€²) =
  let âŸ¨ gâ‚âŠ‘gâ‚â€² , gâ‚‚âŠ‘gâ‚‚â€² âŸ© = cexpr-precâ†’âŠ‘ _ _ cÌ…âŠ‘cÌ…â€² in
  let âŸ¨ BâŠ‘Bâ€² , AâŠ‘Aâ€² âŸ© = coercion-precâ†’âŠ‘ câŠ‘câ€² in
  âŸ¨ âŠ‘-ty gâ‚âŠ‘gâ‚â€² (âŠ‘-ref AâŠ‘Aâ€²) , âŠ‘-ty gâ‚‚âŠ‘gâ‚‚â€² (âŠ‘-ref BâŠ‘Bâ€²) âŸ©
coercion-precâ†’âŠ‘ (âŠ‘-fun dÌ…âŠ‘dÌ…â€² câŠ‘câ€² dâŠ‘dâ€² cÌ…âŠ‘cÌ…â€²) =
  let âŸ¨ gâ‚âŠ‘gâ‚â€²   , gâ‚‚âŠ‘gâ‚‚â€²   âŸ© = cexpr-precâ†’âŠ‘ _ _ cÌ…âŠ‘cÌ…â€² in
  let âŸ¨ gcâ‚‚âŠ‘gcâ‚‚â€² , gcâ‚âŠ‘gcâ‚â€² âŸ© = cexpr-precâ†’âŠ‘ _ _ dÌ…âŠ‘dÌ…â€² in
  let âŸ¨ CâŠ‘Câ€² , AâŠ‘Aâ€² âŸ© = coercion-precâ†’âŠ‘ câŠ‘câ€² in
  let âŸ¨ BâŠ‘Bâ€² , DâŠ‘Dâ€² âŸ© = coercion-precâ†’âŠ‘ dâŠ‘dâ€² in
  âŸ¨ âŠ‘-ty gâ‚âŠ‘gâ‚â€² (âŠ‘-fun gcâ‚âŠ‘gcâ‚â€² AâŠ‘Aâ€² BâŠ‘Bâ€²) , âŠ‘-ty gâ‚‚âŠ‘gâ‚‚â€² (âŠ‘-fun gcâ‚‚âŠ‘gcâ‚‚â€² CâŠ‘Câ€² DâŠ‘Dâ€²) âŸ©

coercion-prec-leftâ†’âŠ‘ : âˆ€ {A Aâ€² B} {c : Cast A â‡’ B}
  â†’ âŸ¨ c âŸ©âŠ‘ Aâ€²
  â†’ A âŠ‘ Aâ€² Ã— B âŠ‘ Aâ€²
coercion-prec-leftâ†’âŠ‘ (âŠ‘-base cÌ…âŠ‘gâ€²) =
  let âŸ¨ gâ‚âŠ‘gâ€² , gâ‚‚âŠ‘gâ€² âŸ© = prec-leftâ†’âŠ‘ _ cÌ…âŠ‘gâ€² in
  âŸ¨ âŠ‘-ty gâ‚âŠ‘gâ€² âŠ‘-Î¹ , âŠ‘-ty gâ‚‚âŠ‘gâ€² âŠ‘-Î¹ âŸ©
coercion-prec-leftâ†’âŠ‘ (âŠ‘-ref câŠ‘Aâ€² dâŠ‘Aâ€² cÌ…âŠ‘gâ€²) =
  let âŸ¨ gâ‚âŠ‘gâ€² , gâ‚‚âŠ‘gâ€² âŸ© = prec-leftâ†’âŠ‘ _ cÌ…âŠ‘gâ€² in
  let âŸ¨ BâŠ‘Aâ€² , AâŠ‘Aâ€² âŸ© = coercion-prec-leftâ†’âŠ‘ câŠ‘Aâ€² in
  âŸ¨ âŠ‘-ty gâ‚âŠ‘gâ€² (âŠ‘-ref AâŠ‘Aâ€²) , âŠ‘-ty gâ‚‚âŠ‘gâ€² (âŠ‘-ref BâŠ‘Aâ€²) âŸ©
coercion-prec-leftâ†’âŠ‘ (âŠ‘-fun dÌ…âŠ‘gcâ€² câŠ‘Aâ€² dâŠ‘Bâ€² cÌ…âŠ‘gâ€²) =
  let âŸ¨ gâ‚âŠ‘gâ€²   , gâ‚‚âŠ‘gâ€²   âŸ© = prec-leftâ†’âŠ‘ _ cÌ…âŠ‘gâ€² in
  let âŸ¨ gcâ‚‚âŠ‘gcâ€² , gcâ‚âŠ‘gcâ€² âŸ© = prec-leftâ†’âŠ‘ _ dÌ…âŠ‘gcâ€² in
  let âŸ¨ CâŠ‘Aâ€² , AâŠ‘Aâ€² âŸ© = coercion-prec-leftâ†’âŠ‘ câŠ‘Aâ€² in
  let âŸ¨ BâŠ‘Bâ€² , DâŠ‘Bâ€² âŸ© = coercion-prec-leftâ†’âŠ‘ dâŠ‘Bâ€² in
  âŸ¨ âŠ‘-ty gâ‚âŠ‘gâ€² (âŠ‘-fun gcâ‚âŠ‘gcâ€² AâŠ‘Aâ€² BâŠ‘Bâ€²) , âŠ‘-ty gâ‚‚âŠ‘gâ€² (âŠ‘-fun gcâ‚‚âŠ‘gcâ€² CâŠ‘Aâ€² DâŠ‘Bâ€²) âŸ©

coercion-prec-rightâ†’âŠ‘ : âˆ€ {A Aâ€² Bâ€²} {c : Cast Aâ€² â‡’ Bâ€²}
  â†’ A âŠ‘âŸ¨ c âŸ©
  â†’ A âŠ‘ Aâ€² Ã— A âŠ‘ Bâ€²
coercion-prec-rightâ†’âŠ‘ (âŠ‘-base gâŠ‘cÌ…â€²) =
  let âŸ¨ gâŠ‘gâ‚â€² , gâŠ‘gâ‚‚â€² âŸ© = prec-rightâ†’âŠ‘ _ gâŠ‘cÌ…â€² in
  âŸ¨ âŠ‘-ty gâŠ‘gâ‚â€² âŠ‘-Î¹ , âŠ‘-ty gâŠ‘gâ‚‚â€² âŠ‘-Î¹ âŸ©
coercion-prec-rightâ†’âŠ‘ (âŠ‘-ref AâŠ‘câ€² AâŠ‘dâ€² gâŠ‘cÌ…â€²) =
  let âŸ¨ gâŠ‘gâ‚â€² , gâŠ‘gâ‚‚â€² âŸ© = prec-rightâ†’âŠ‘ _ gâŠ‘cÌ…â€² in
  let âŸ¨ AâŠ‘Bâ€² , AâŠ‘Aâ€² âŸ© = coercion-prec-rightâ†’âŠ‘ AâŠ‘câ€² in
  âŸ¨ âŠ‘-ty gâŠ‘gâ‚â€² (âŠ‘-ref AâŠ‘Aâ€²) , âŠ‘-ty gâŠ‘gâ‚‚â€² (âŠ‘-ref AâŠ‘Bâ€²) âŸ©
coercion-prec-rightâ†’âŠ‘ (âŠ‘-fun gcâŠ‘dÌ…â€² AâŠ‘câ€² BâŠ‘dâ€² gâŠ‘cÌ…â€²) =
  let âŸ¨ gâŠ‘gâ‚â€²   , gâŠ‘gâ‚‚â€²   âŸ© = prec-rightâ†’âŠ‘ _ gâŠ‘cÌ…â€² in
  let âŸ¨ gcâŠ‘gcâ‚‚â€² , gcâŠ‘gcâ‚â€² âŸ© = prec-rightâ†’âŠ‘ _ gcâŠ‘dÌ…â€² in
  let âŸ¨ AâŠ‘Câ€² , AâŠ‘Aâ€² âŸ© = coercion-prec-rightâ†’âŠ‘ AâŠ‘câ€² in
  let âŸ¨ BâŠ‘Bâ€² , BâŠ‘Dâ€² âŸ© = coercion-prec-rightâ†’âŠ‘ BâŠ‘dâ€² in
  âŸ¨ âŠ‘-ty gâŠ‘gâ‚â€² (âŠ‘-fun gcâŠ‘gcâ‚â€² AâŠ‘Aâ€² BâŠ‘Bâ€²) , âŠ‘-ty gâŠ‘gâ‚‚â€² (âŠ‘-fun gcâŠ‘gcâ‚‚â€² AâŠ‘Câ€² BâŠ‘Dâ€²) âŸ©


comp-pres-prec-ll : âˆ€ {A Aâ€² B C} {c : Cast A â‡’ B} {d : Cast B â‡’ C}
  â†’ âŸ¨     c âŸ©âŠ‘ Aâ€²
  â†’ âŸ¨     d âŸ©âŠ‘ Aâ€²
    -----------------------
  â†’ âŸ¨ c â¨Ÿ d âŸ©âŠ‘ Aâ€²
comp-pres-prec-ll (âŠ‘-base cÌ…âŠ‘gâ€²) (âŠ‘-base dÌ…âŠ‘gâ€²) = âŠ‘-base (comp-pres-âŠ‘-ll cÌ…âŠ‘gâ€² dÌ…âŠ‘gâ€²)
comp-pres-prec-ll (âŠ‘-ref câ‚âŠ‘Aâ€² dâ‚âŠ‘Aâ€² cÌ…âŠ‘gâ€²) (âŠ‘-ref câ‚‚âŠ‘Aâ€² dâ‚‚âŠ‘Aâ€² dÌ…âŠ‘gâ€²) =
  âŠ‘-ref (comp-pres-prec-ll câ‚‚âŠ‘Aâ€² câ‚âŠ‘Aâ€²) (comp-pres-prec-ll dâ‚âŠ‘Aâ€² dâ‚‚âŠ‘Aâ€²)
        (comp-pres-âŠ‘-ll cÌ…âŠ‘gâ€² dÌ…âŠ‘gâ€²)
comp-pres-prec-ll (âŠ‘-fun dÌ…â‚âŠ‘gcâ€² câ‚âŠ‘Aâ€² dâ‚âŠ‘Bâ€² cÌ…â‚âŠ‘gâ€²) (âŠ‘-fun dÌ…â‚‚âŠ‘gcâ€² câ‚‚âŠ‘Aâ€² dâ‚‚âŠ‘Bâ€² cÌ…â‚‚âŠ‘gâ€²) =
  âŠ‘-fun (comp-pres-âŠ‘-ll dÌ…â‚‚âŠ‘gcâ€² dÌ…â‚âŠ‘gcâ€²) (comp-pres-prec-ll câ‚‚âŠ‘Aâ€² câ‚âŠ‘Aâ€²)
        (comp-pres-prec-ll dâ‚âŠ‘Bâ€² dâ‚‚âŠ‘Bâ€²) (comp-pres-âŠ‘-ll cÌ…â‚âŠ‘gâ€² cÌ…â‚‚âŠ‘gâ€²)


comp-pres-prec-bl : âˆ€ {A Aâ€² B Bâ€² C} {c : Cast A â‡’ B} {d : Cast B â‡’ C}
                      {câ€² : Cast Aâ€² â‡’ Bâ€²}
  â†’ âŸ¨     c âŸ©âŠ‘âŸ¨ câ€² âŸ©
  â†’ âŸ¨     d âŸ©âŠ‘ Bâ€²
    -----------------------
  â†’ âŸ¨ c â¨Ÿ d âŸ©âŠ‘âŸ¨ câ€² âŸ©

comp-pres-prec-lb : âˆ€ {A Aâ€² B Bâ€² C} {c : Cast A â‡’ B} {d : Cast B â‡’ C}
                      {câ€² : Cast Aâ€² â‡’ Bâ€²}
  â†’ âŸ¨     c âŸ©âŠ‘ Aâ€²
  â†’ âŸ¨     d âŸ©âŠ‘âŸ¨ câ€² âŸ©
    -----------------------
  â†’ âŸ¨ c â¨Ÿ d âŸ©âŠ‘âŸ¨ câ€² âŸ©

comp-pres-prec-bl (âŠ‘-base cÌ…âŠ‘cÌ…â€²) (âŠ‘-base dÌ…âŠ‘gâ€²) = âŠ‘-base (comp-pres-âŠ‘-bl cÌ…âŠ‘cÌ…â€² dÌ…âŠ‘gâ€²)
comp-pres-prec-bl (âŠ‘-ref câŠ‘câ€² dâŠ‘dâ€² cÌ…âŠ‘cÌ…â€²) (âŠ‘-ref câŠ‘Aâ€² dâŠ‘Aâ€² cÌ…âŠ‘gâ€²) =
  âŠ‘-ref (comp-pres-prec-lb câŠ‘Aâ€² câŠ‘câ€²) (comp-pres-prec-bl dâŠ‘dâ€² dâŠ‘Aâ€²)
        (comp-pres-âŠ‘-bl cÌ…âŠ‘cÌ…â€² cÌ…âŠ‘gâ€²)
comp-pres-prec-bl (âŠ‘-fun dÌ…âŠ‘dÌ…â€² câŠ‘câ€² dâŠ‘dâ€² cÌ…âŠ‘cÌ…â€²) (âŠ‘-fun dÌ…âŠ‘gcâ€² câŠ‘Aâ€² dâŠ‘Bâ€² cÌ…âŠ‘gâ€²) =
  âŠ‘-fun (comp-pres-âŠ‘-lb dÌ…âŠ‘gcâ€² dÌ…âŠ‘dÌ…â€²) (comp-pres-prec-lb câŠ‘Aâ€² câŠ‘câ€²)
        (comp-pres-prec-bl dâŠ‘dâ€² dâŠ‘Bâ€²) (comp-pres-âŠ‘-bl cÌ…âŠ‘cÌ…â€² cÌ…âŠ‘gâ€²)

comp-pres-prec-lb (âŠ‘-base dÌ…âŠ‘gâ€²) (âŠ‘-base cÌ…âŠ‘cÌ…â€²) = âŠ‘-base (comp-pres-âŠ‘-lb dÌ…âŠ‘gâ€² cÌ…âŠ‘cÌ…â€²)
comp-pres-prec-lb (âŠ‘-ref câŠ‘Aâ€² dâŠ‘Aâ€² cÌ…âŠ‘gâ€²) (âŠ‘-ref câŠ‘câ€² dâŠ‘dâ€² cÌ…âŠ‘cÌ…â€²) =
  âŠ‘-ref (comp-pres-prec-bl câŠ‘câ€² câŠ‘Aâ€²) (comp-pres-prec-lb dâŠ‘Aâ€² dâŠ‘dâ€²)
        (comp-pres-âŠ‘-lb cÌ…âŠ‘gâ€² cÌ…âŠ‘cÌ…â€²)
comp-pres-prec-lb (âŠ‘-fun dÌ…âŠ‘gcâ€² câŠ‘Aâ€² dâŠ‘Bâ€² cÌ…âŠ‘gâ€²) (âŠ‘-fun dÌ…âŠ‘dÌ…â€² câŠ‘câ€² dâŠ‘dâ€² cÌ…âŠ‘cÌ…â€²) =
  âŠ‘-fun (comp-pres-âŠ‘-bl dÌ…âŠ‘dÌ…â€² dÌ…âŠ‘gcâ€²) (comp-pres-prec-bl câŠ‘câ€² câŠ‘Aâ€²)
        (comp-pres-prec-lb dâŠ‘Bâ€² dâŠ‘dâ€²) (comp-pres-âŠ‘-lb cÌ…âŠ‘gâ€² cÌ…âŠ‘cÌ…â€²)

comp-pres-prec-rl : âˆ€ {A Aâ€² B Bâ€²} {c : Cast A â‡’ B} {câ€² : Cast Aâ€² â‡’ Bâ€²}
  â†’ A âŠ‘âŸ¨ câ€² âŸ©
  â†’ âŸ¨ c âŸ©âŠ‘ Bâ€²
    -----------------------
  â†’ âŸ¨ c âŸ©âŠ‘âŸ¨ câ€² âŸ©

comp-pres-prec-lr : âˆ€ {A Aâ€² B Bâ€²} {c : Cast A â‡’ B} {câ€² : Cast Aâ€² â‡’ Bâ€²}
  â†’ âŸ¨ c âŸ©âŠ‘ Aâ€²
  â†’ B âŠ‘âŸ¨ câ€² âŸ©
    -----------------------
  â†’ âŸ¨ c âŸ©âŠ‘âŸ¨ câ€² âŸ©

comp-pres-prec-rl (âŠ‘-base gâŠ‘cÌ…â€²) (âŠ‘-base cÌ…âŠ‘gâ€²) = âŠ‘-base (comp-pres-âŠ‘-rl gâŠ‘cÌ…â€² cÌ…âŠ‘gâ€²)
comp-pres-prec-rl (âŠ‘-ref AâŠ‘câ€² AâŠ‘dâ€² gâŠ‘cÌ…â€²) (âŠ‘-ref câŠ‘Aâ€² dâŠ‘Aâ€² cÌ…âŠ‘gâ€²) =
  âŠ‘-ref (comp-pres-prec-lr câŠ‘Aâ€² AâŠ‘câ€²) (comp-pres-prec-rl AâŠ‘dâ€² dâŠ‘Aâ€²)
        (comp-pres-âŠ‘-rl gâŠ‘cÌ…â€² cÌ…âŠ‘gâ€²)
comp-pres-prec-rl (âŠ‘-fun gcâŠ‘dÌ…â€² AâŠ‘câ€² BâŠ‘dâ€² gâŠ‘cÌ…â€²) (âŠ‘-fun dÌ…âŠ‘gcâ€² câŠ‘Aâ€² dâŠ‘Bâ€² cÌ…âŠ‘gâ€²) =
  âŠ‘-fun (comp-pres-âŠ‘-lr dÌ…âŠ‘gcâ€² gcâŠ‘dÌ…â€²) (comp-pres-prec-lr câŠ‘Aâ€² AâŠ‘câ€²)
        (comp-pres-prec-rl BâŠ‘dâ€² dâŠ‘Bâ€²) (comp-pres-âŠ‘-rl gâŠ‘cÌ…â€² cÌ…âŠ‘gâ€²)

comp-pres-prec-lr (âŠ‘-base cÌ…âŠ‘gâ€²) (âŠ‘-base gâŠ‘cÌ…â€²) = âŠ‘-base (comp-pres-âŠ‘-lr cÌ…âŠ‘gâ€² gâŠ‘cÌ…â€²)
comp-pres-prec-lr (âŠ‘-ref câŠ‘Aâ€² dâŠ‘Aâ€² cÌ…âŠ‘gâ€²) (âŠ‘-ref AâŠ‘câ€² AâŠ‘dâ€² gâŠ‘cÌ…â€²) =
  âŠ‘-ref (comp-pres-prec-rl AâŠ‘câ€² câŠ‘Aâ€²) (comp-pres-prec-lr dâŠ‘Aâ€² AâŠ‘dâ€²)
        (comp-pres-âŠ‘-lr cÌ…âŠ‘gâ€² gâŠ‘cÌ…â€²)
comp-pres-prec-lr (âŠ‘-fun dÌ…âŠ‘gcâ€² câŠ‘Aâ€² dâŠ‘Bâ€² cÌ…âŠ‘gâ€²) (âŠ‘-fun gcâŠ‘dÌ…â€² AâŠ‘câ€² BâŠ‘dâ€² gâŠ‘cÌ…â€²) =
  âŠ‘-fun (comp-pres-âŠ‘-rl gcâŠ‘dÌ…â€² dÌ…âŠ‘gcâ€²) (comp-pres-prec-rl AâŠ‘câ€² câŠ‘Aâ€²)
        (comp-pres-prec-lr dâŠ‘Bâ€² BâŠ‘dâ€²) (comp-pres-âŠ‘-lr cÌ…âŠ‘gâ€² gâŠ‘cÌ…â€²)




infix 4 _Í¾_âˆ£_Í¾_âˆ£_Í¾_âˆ£_Í¾_âŠ¢_âŠ‘_â‡_âŠ‘_

data _Í¾_âˆ£_Í¾_âˆ£_Í¾_âˆ£_Í¾_âŠ¢_âŠ‘_â‡_âŠ‘_ : (Î“ Î“â€² : Context) (Î£ Î£â€² : HeapContext)
  (g gâ€² : Label) (â„“ â„“â€² : StaticLabel) (M Mâ€² : Term) (A Aâ€² : Type) â†’ Set where

  âŠ‘-var : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€² A Aâ€² x}
    â†’ Î“  âˆ‹ x â¦‚ A
    â†’ Î“â€² âˆ‹ x â¦‚ Aâ€²
      ---------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ ` x âŠ‘ ` x â‡ A âŠ‘ Aâ€²


  âŠ‘-const : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€² Î¹ â„“} {k : rep Î¹}
      ---------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ $ k âŠ‘ $ k
         â‡ ` Î¹ of l â„“ âŠ‘ ` Î¹ of l â„“


  âŠ‘-addr : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {n â„“ â„“Ì‚ T Tâ€²}
    â†’ lookup-Î£ Î£  (aâŸ¦ â„“Ì‚ âŸ§ n) â‰¡ just T
    â†’ lookup-Î£ Î£â€² (aâŸ¦ â„“Ì‚ âŸ§ n) â‰¡ just Tâ€²
      -------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ addr n âŠ‘ addr n
         â‡ Ref (T of l â„“Ì‚) of l â„“ âŠ‘ Ref (Tâ€² of l â„“Ì‚) of l â„“


  âŠ‘-lam : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {N Nâ€²} {g gâ€² A Aâ€² B Bâ€² â„“}
    â†’ g âŠ‘â‚— gâ€²
    â†’ A âŠ‘  Aâ€²
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ A âˆ· Î“ Í¾ Aâ€² âˆ· Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ g Í¾ gâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ N âŠ‘ Nâ€² â‡ B âŠ‘ Bâ€²)
      --------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ Æ› N âŠ‘ Æ› Nâ€²
         â‡ âŸ¦ g âŸ§ A â‡’ B of l â„“ âŠ‘ âŸ¦ gâ€² âŸ§ Aâ€² â‡’ Bâ€² of l â„“


  âŠ‘-app : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {A Aâ€² B Bâ€² C Câ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ âŸ¦ l (â„“c â‹ â„“) âŸ§ A â‡’ B of l â„“ âŠ‘ âŸ¦ l (â„“c â‹ â„“) âŸ§ Aâ€² â‡’ Bâ€² of l â„“
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ C  â‰¡ stamp B  (l â„“)
    â†’ Câ€² â‰¡ stamp Bâ€² (l â„“)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ app L M A B â„“ âŠ‘ app Lâ€² Mâ€² Aâ€² Bâ€² â„“ â‡ C âŠ‘ Câ€²


  âŠ‘-app! : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {A Aâ€² B Bâ€² C Câ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ âŸ¦ â‹† âŸ§ A â‡’ B of â‹† âŠ‘ âŸ¦ â‹† âŸ§ Aâ€² â‡’ Bâ€² of â‹†
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ C  â‰¡ stamp B  â‹†
    â†’ Câ€² â‰¡ stamp Bâ€² â‹†
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ app! L M A B âŠ‘ app! Lâ€² Mâ€² Aâ€² Bâ€² â‡ C âŠ‘ Câ€²


  âŠ‘-app!l : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {A Aâ€² B Bâ€² C Câ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ âŸ¦ â‹† âŸ§ A â‡’ B of â‹† âŠ‘ âŸ¦ l (â„“c â‹ â„“) âŸ§ Aâ€² â‡’ Bâ€² of l â„“
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ C  â‰¡ stamp B     â‹†
    â†’ Câ€² â‰¡ stamp Bâ€² (l â„“)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ app! L M A B âŠ‘ app Lâ€² Mâ€² Aâ€² Bâ€² â„“ â‡ C âŠ‘ Câ€²


  âŠ‘-if : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€² N Nâ€²} {A Aâ€² B Bâ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ ` Bool of l â„“ âŠ‘ ` Bool of l â„“
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l (â„“c â‹ â„“) Í¾ l (â„“c â‹ â„“) âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ A âŠ‘ Aâ€²)
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l (â„“c â‹ â„“) Í¾ l (â„“c â‹ â„“) âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ N âŠ‘ Nâ€²
         â‡ A âŠ‘ Aâ€²)
    â†’ B  â‰¡ stamp A  (l â„“)
    â†’ Bâ€² â‰¡ stamp Aâ€² (l â„“)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ if L A â„“ M N âŠ‘ if Lâ€² Aâ€² â„“ Mâ€² Nâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-if! : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {L Lâ€² M Mâ€² N Nâ€²} {A Aâ€² B Bâ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ ` Bool of â‹† âŠ‘ ` Bool of â‹†
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ â‹† âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ A âŠ‘ Aâ€²)
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ â‹† âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ N âŠ‘ Nâ€²
         â‡ A âŠ‘ Aâ€²)
    â†’ B  â‰¡ stamp A  â‹†
    â†’ Bâ€² â‰¡ stamp Aâ€² â‹†
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ if! L A M N âŠ‘ if! Lâ€² Aâ€² Mâ€² Nâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-if!l : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€² N Nâ€²} {A Aâ€² B Bâ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ ` Bool of â‹† âŠ‘ ` Bool of l â„“
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ l (â„“c â‹ â„“) âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ A âŠ‘ Aâ€²)
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ l (â„“c â‹ â„“) âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ N âŠ‘ Nâ€²
         â‡ A âŠ‘ Aâ€²)
    â†’ B  â‰¡ stamp A  â‹†
    â†’ Bâ€² â‰¡ stamp Aâ€² (l â„“)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ if! L A M N âŠ‘ if Lâ€² Aâ€² â„“ Mâ€² Nâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-let : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€² N Nâ€²} {A Aâ€² B Bâ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ A âŠ‘ Aâ€²
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ A âˆ· Î“ Í¾ Aâ€² âˆ· Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ N âŠ‘ Nâ€²
         â‡ B âŠ‘ Bâ€²)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ `let M A N âŠ‘ `let Mâ€² Aâ€² Nâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-ref : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“c â„“v â„“vâ€²} {M Mâ€²} {T Tâ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ T of l â„“ âŠ‘ Tâ€² of l â„“
    â†’ â„“c â‰¼ â„“
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ refâŸ¦ â„“ âŸ§ M âŠ‘ refâŸ¦ â„“ âŸ§ Mâ€²
         â‡ Ref (T of l â„“) of l low âŠ‘ Ref (Tâ€² of l â„“) of l low


  âŠ‘-ref? : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“v â„“vâ€²} {M Mâ€²} {T Tâ€² â„“} {p q}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ â‹† âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ T of l â„“ âŠ‘ Tâ€² of l â„“
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ â‹† âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ ref?âŸ¦ â„“ âŸ§ M p âŠ‘ ref?âŸ¦ â„“ âŸ§ Mâ€² q
         â‡ Ref (T of l â„“) of l low âŠ‘ Ref (Tâ€² of l â„“) of l low


  âŠ‘-ref?l : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“c â„“v â„“vâ€²} {M Mâ€²} {T Tâ€² â„“} {p}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ T of l â„“ âŠ‘ Tâ€² of l â„“
    â†’ â„“c â‰¼ â„“
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ â‹† Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ ref?âŸ¦ â„“ âŸ§ M p âŠ‘ refâŸ¦ â„“ âŸ§ Mâ€²
         â‡ Ref (T of l â„“) of l low âŠ‘ Ref (Tâ€² of l â„“) of l low


  âŠ‘-deref : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€² B Bâ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ Ref A of l â„“ âŠ‘ Ref Aâ€² of l â„“
    â†’ B  â‰¡ stamp A  (l â„“)
    â†’ Bâ€² â‰¡ stamp Aâ€² (l â„“)
      ----------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ ! M A â„“ âŠ‘ ! Mâ€² Aâ€² â„“ â‡ B âŠ‘ Bâ€²


  âŠ‘-deref! : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€² B Bâ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ Ref A of â‹† âŠ‘ Ref Aâ€² of â‹†
    â†’ B  â‰¡ stamp A  â‹†
    â†’ Bâ€² â‰¡ stamp Aâ€² â‹†
      ----------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ !! M A âŠ‘ !! Mâ€² Aâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-deref!l : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€² B Bâ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ Ref A of â‹† âŠ‘ Ref Aâ€² of l â„“
    â†’ B  â‰¡ stamp A  â‹†
    â†’ Bâ€² â‰¡ stamp Aâ€² (l â„“)
      ----------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ !! M A âŠ‘ ! Mâ€² Aâ€² â„“ â‡ B âŠ‘ Bâ€²


  âŠ‘-assign : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {T Tâ€² â„“Ì‚ â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ Ref (T of l â„“Ì‚) of l â„“ âŠ‘ Ref (Tâ€² of l â„“Ì‚) of l â„“
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ T of l â„“Ì‚ âŠ‘ Tâ€² of l â„“Ì‚
    â†’ â„“c â‰¼ â„“Ì‚ â†’ â„“ â‰¼ â„“Ì‚
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ assign L M T â„“Ì‚ â„“ âŠ‘ assign Lâ€² Mâ€² Tâ€² â„“Ì‚ â„“
         â‡ ` Unit of l low âŠ‘ ` Unit of l low


  âŠ‘-assign? : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {T Tâ€² gÌ‚ gÌ‚â€² g gâ€²} {p q}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ Ref (T of gÌ‚) of g âŠ‘ Ref (Tâ€² of gÌ‚â€²) of gâ€²
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ T of gÌ‚ âŠ‘ Tâ€² of gÌ‚â€²
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ assign? L M T gÌ‚ g p âŠ‘ assign? Lâ€² Mâ€² Tâ€² gÌ‚â€² gâ€² q
         â‡ ` Unit of l low âŠ‘ ` Unit of l low


  âŠ‘-assign?l : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {T Tâ€² gÌ‚ â„“Ì‚ g â„“} {p}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ Ref (T of gÌ‚) of g âŠ‘ Ref (Tâ€² of l â„“Ì‚) of l â„“
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€²
         â‡ T of gÌ‚ âŠ‘ Tâ€² of l â„“Ì‚
    â†’ â„“c â‰¼ â„“Ì‚ â†’ â„“ â‰¼ â„“Ì‚
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ assign? L M T gÌ‚ g p âŠ‘ assign Lâ€² Mâ€² Tâ€² â„“Ì‚ â„“
         â‡ ` Unit of l low âŠ‘ ` Unit of l low


  âŠ‘-prot : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“vâ‚ â„“vâ‚â€²} {M Mâ€² PC PCâ€²} {A Aâ€² B Bâ€² g gâ€² â„“} {vc vcâ€²}
    â†’ let â„“vâ‚‚  = âˆ¥ PC  âˆ¥ vc  in
       let â„“vâ‚‚â€² = âˆ¥ PCâ€² âˆ¥ vcâ€² in
       Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ g Í¾ gâ€² âˆ£ â„“vâ‚‚ Í¾ â„“vâ‚‚â€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ PC âŠ‘ PCâ€² â‡ g âŠ‘ gâ€²
    â†’ â„“vâ‚  â‹ â„“  â‰¼ â„“vâ‚‚
    â†’ â„“vâ‚â€² â‹ â„“ â‰¼ â„“vâ‚‚â€²
    â†’ B  â‰¡ stamp A  (l â„“)
    â†’ Bâ€² â‰¡ stamp Aâ€² (l â„“)
      ----------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“vâ‚ Í¾ â„“vâ‚â€² âŠ¢ prot PC vc â„“ M A âŠ‘ prot PCâ€² vcâ€² â„“ Mâ€² Aâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-prot! : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“vâ‚ â„“vâ‚â€²} {M Mâ€² PC PCâ€²} {A Aâ€² B Bâ€² g gâ€² â„“ â„“â€²} {vc vcâ€²}
    â†’ let â„“vâ‚‚  = âˆ¥ PC  âˆ¥ vc  in
       let â„“vâ‚‚â€² = âˆ¥ PCâ€² âˆ¥ vcâ€² in
       Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ g Í¾ gâ€² âˆ£ â„“vâ‚‚ Í¾ â„“vâ‚‚â€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ PC âŠ‘ PCâ€² â‡ g âŠ‘ gâ€²
    â†’ â„“vâ‚  â‹ â„“  â‰¼ â„“vâ‚‚
    â†’ â„“vâ‚â€² â‹ â„“â€² â‰¼ â„“vâ‚‚â€²
    â†’ B  â‰¡ stamp A  â‹†
    â†’ Bâ€² â‰¡ stamp Aâ€² â‹†
    â†’ â„“ â‰¼ â„“â€²
      ----------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“vâ‚ Í¾ â„“vâ‚â€² âŠ¢ prot! PC vc â„“ M A âŠ‘ prot! PCâ€² vcâ€² â„“â€² Mâ€² Aâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-prot!l : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“vâ‚ â„“vâ‚â€²} {M Mâ€² PC PCâ€²} {A Aâ€² B Bâ€² g gâ€² â„“ â„“â€²} {vc vcâ€²}
    â†’ let â„“vâ‚‚  = âˆ¥ PC  âˆ¥ vc  in
       let â„“vâ‚‚â€² = âˆ¥ PCâ€² âˆ¥ vcâ€² in
       Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ g Í¾ gâ€² âˆ£ â„“vâ‚‚ Í¾ â„“vâ‚‚â€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ PC âŠ‘ PCâ€² â‡ g âŠ‘ gâ€²
    â†’ â„“vâ‚  â‹ â„“  â‰¼ â„“vâ‚‚
    â†’ â„“vâ‚â€² â‹ â„“â€² â‰¼ â„“vâ‚‚â€²
    â†’ B  â‰¡ stamp A  â‹†
    â†’ Bâ€² â‰¡ stamp Aâ€² (l â„“â€²)
    â†’ â„“ â‰¼ â„“â€²
      ----------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“vâ‚ Í¾ â„“vâ‚â€² âŠ¢ prot! PC vc â„“ M A âŠ‘ prot PCâ€² vcâ€² â„“â€² Mâ€² Aâ€² â‡ B âŠ‘ Bâ€²


  âŠ‘-cast : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€² B Bâ€²}
             {c : Cast A â‡’ B} {câ€² : Cast Aâ€² â‡’ Bâ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ âŸ¨ c âŸ©âŠ‘âŸ¨ câ€² âŸ©
      -------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŸ¨ c âŸ© âŠ‘ Mâ€² âŸ¨ câ€² âŸ© â‡ B âŠ‘ Bâ€²


  âŠ‘-castl : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€² B} {c : Cast A â‡’ B}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ âŸ¨ c âŸ©âŠ‘ Aâ€²
      -------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŸ¨ c âŸ© âŠ‘ Mâ€² â‡ B âŠ‘ Aâ€²


  âŠ‘-castr : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€² Bâ€²} {câ€² : Cast Aâ€² â‡’ Bâ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ A âŠ‘âŸ¨ câ€² âŸ©
      -------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² âŸ¨ câ€² âŸ© â‡ A âŠ‘ Bâ€²


  âŠ‘-blame : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M A Aâ€² p}
    â†’ Î“ Í¾ Î£ Í¾ gc Í¾ â„“v âŠ¢ M â‡ A
    â†’ A âŠ‘ Aâ€²
      ------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ blame p â‡ A âŠ‘ Aâ€²


{- The term precision relation implies that both terms are well-typed.
   Furthermore, their types are related by type precision. -}
cc-prec-inv : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€²}
  â†’ Î“ âŠ‘* Î“â€²
  â†’ Î£ âŠ‘â‚˜ Î£â€²
  â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    -------------------------------------------------------------
  â†’ Î“  Í¾ Î£  Í¾ gc  Í¾ â„“v  âŠ¢ M  â‡ A    Ã—
     Î“â€² Í¾ Î£â€² Í¾ gcâ€² Í¾ â„“vâ€² âŠ¢ Mâ€² â‡ Aâ€²   Ã—
     A âŠ‘ Aâ€²
cc-prec-inv Î“âŠ‘Î“â€² _ (âŠ‘-var Î“âˆ‹x Î“â€²âˆ‹x) = âŸ¨ âŠ¢var Î“âˆ‹x , âŠ¢var Î“â€²âˆ‹x , âŠ‘*â†’âŠ‘ Î“âŠ‘Î“â€² Î“âˆ‹x Î“â€²âˆ‹x âŸ©
cc-prec-inv _ _ âŠ‘-const = âŸ¨ âŠ¢const , âŠ¢const , âŠ‘-ty lâŠ‘l âŠ‘-Î¹ âŸ©
cc-prec-inv _ Î£âŠ‘Î£â€² (âŠ‘-addr {n = n} {â„“} {â„“Ì‚} Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²) =
  âŸ¨ âŠ¢addr Î£aâ‰¡T , âŠ¢addr Î£â€²aâ‰¡Tâ€² , âŠ‘-ty lâŠ‘l (âŠ‘-ref (âŠ‘-ty lâŠ‘l (âŠ‘â‚˜â†’âŠ‘ {n = n} {â„“Ì‚} Î£âŠ‘Î£â€² Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²))) âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-lam gâŠ‘gâ€² AâŠ‘Aâ€² NâŠ‘Nâ€²) =
  let prec* = âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€² in
  âŸ¨ âŠ¢lam (projâ‚        (cc-prec-inv {â„“vâ€² = low} prec* Î£âŠ‘Î£â€² NâŠ‘Nâ€²))  ,
    âŠ¢lam (projâ‚ (projâ‚‚ (cc-prec-inv {â„“v  = low} prec* Î£âŠ‘Î£â€² NâŠ‘Nâ€²))) ,
    âŠ‘-ty lâŠ‘l (âŠ‘-fun gâŠ‘gâ€² AâŠ‘Aâ€² (projâ‚‚ (projâ‚‚ (cc-prec-inv {â„“v = low} {low} prec* Î£âŠ‘Î£â€² NâŠ‘Nâ€²)))) âŸ©
{- Application -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-app {C = C} {Câ€²} LâŠ‘Lâ€² MâŠ‘Mâ€² eq eqâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , Aâ†’BâŠ‘Aâ€²â†’Bâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _           âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  case Aâ†’BâŠ‘Aâ€²â†’Bâ€² of Î» where
  (âŠ‘-ty lâŠ‘l (âŠ‘-fun lâŠ‘l AâŠ‘Aâ€² BâŠ‘Bâ€²)) â†’
    let CâŠ‘Câ€² : C âŠ‘ Câ€²
        CâŠ‘Câ€² = substâ‚‚ _âŠ‘_ (sym eq) (sym eqâ€²) (stamp-âŠ‘ BâŠ‘Bâ€² lâŠ‘l) in
    âŸ¨ âŠ¢app âŠ¢L âŠ¢M eq , âŠ¢app âŠ¢Lâ€² âŠ¢Mâ€² eqâ€² , CâŠ‘Câ€² âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-app! {C = C} {Câ€²} LâŠ‘Lâ€² MâŠ‘Mâ€² eq eqâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , Aâ†’BâŠ‘Aâ€²â†’Bâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _           âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  case Aâ†’BâŠ‘Aâ€²â†’Bâ€² of Î» where
  (âŠ‘-ty â‹†âŠ‘ (âŠ‘-fun â‹†âŠ‘ AâŠ‘Aâ€² BâŠ‘Bâ€²)) â†’
    let CâŠ‘Câ€² : C âŠ‘ Câ€²
        CâŠ‘Câ€² = substâ‚‚ _âŠ‘_ (sym eq) (sym eqâ€²) (stamp-âŠ‘ BâŠ‘Bâ€² â‹†âŠ‘) in
    âŸ¨ âŠ¢app! âŠ¢L âŠ¢M eq , âŠ¢app! âŠ¢Lâ€² âŠ¢Mâ€² eqâ€² , CâŠ‘Câ€² âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-app!l {C = C} {Câ€²} LâŠ‘Lâ€² MâŠ‘Mâ€² eq eqâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , Aâ†’BâŠ‘Aâ€²â†’Bâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _           âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  case Aâ†’BâŠ‘Aâ€²â†’Bâ€² of Î» where
  (âŠ‘-ty â‹†âŠ‘ (âŠ‘-fun â‹†âŠ‘ AâŠ‘Aâ€² BâŠ‘Bâ€²)) â†’
    let CâŠ‘Câ€² : C âŠ‘ Câ€²
        CâŠ‘Câ€² = substâ‚‚ _âŠ‘_ (sym eq) (sym eqâ€²) (stamp-âŠ‘ BâŠ‘Bâ€² â‹†âŠ‘) in
    âŸ¨ âŠ¢app! âŠ¢L âŠ¢M eq , âŠ¢app âŠ¢Lâ€² âŠ¢Mâ€² eqâ€² , CâŠ‘Câ€² âŸ©
{- If -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-if LâŠ‘Lâ€² MâŠ‘Mâ€² NâŠ‘Nâ€² eq eqâ€²) rewrite eq | eqâ€² =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let ihm = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let ihn = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² NâŠ‘Nâ€² in
  âŸ¨ âŠ¢if âŠ¢L (projâ‚ (ihm _ low)) (projâ‚ (ihn _ low)) refl ,
    âŠ¢if âŠ¢Lâ€² (projâ‚ (projâ‚‚ (ihm low _))) (projâ‚ (projâ‚‚ (ihn low _))) refl ,
    stamp-âŠ‘ (projâ‚‚ (projâ‚‚ (ihm low low))) lâŠ‘l âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-if! LâŠ‘Lâ€² MâŠ‘Mâ€² NâŠ‘Nâ€² eq eqâ€²) rewrite eq | eqâ€² =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let ihm = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let ihn = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² NâŠ‘Nâ€² in
  âŸ¨ âŠ¢if! âŠ¢L (projâ‚ (ihm _ low)) (projâ‚ (ihn _ low)) refl ,
    âŠ¢if! âŠ¢Lâ€² (projâ‚ (projâ‚‚ (ihm low _))) (projâ‚ (projâ‚‚ (ihn low _))) refl ,
    stamp-âŠ‘ (projâ‚‚ (projâ‚‚ (ihm low low))) â‹†âŠ‘ âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-if!l LâŠ‘Lâ€² MâŠ‘Mâ€² NâŠ‘Nâ€² eq eqâ€²) rewrite eq | eqâ€² =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let ihm = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let ihn = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² NâŠ‘Nâ€² in
  âŸ¨ âŠ¢if! âŠ¢L (projâ‚ (ihm _ low)) (projâ‚ (ihn _ low)) refl ,
    âŠ¢if  âŠ¢Lâ€² (projâ‚ (projâ‚‚ (ihm low _))) (projâ‚ (projâ‚‚ (ihn low _))) refl ,
    stamp-âŠ‘ (projâ‚‚ (projâ‚‚ (ihm low low))) â‹†âŠ‘ âŸ©
{- Let -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-let MâŠ‘Mâ€² NâŠ‘Nâ€²) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let ih = Î» â„“v â„“vâ€² â†’ cc-prec-inv {â„“v = â„“v} {â„“vâ€²} (âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€²) Î£âŠ‘Î£â€² NâŠ‘Nâ€² in
  âŸ¨ âŠ¢let âŠ¢M (projâ‚ (ih _ low)) ,
    âŠ¢let âŠ¢Mâ€² (projâ‚ (projâ‚‚ (ih low _))) ,
    projâ‚‚ (projâ‚‚ (ih low low)) âŸ©
{- Reference creation -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-ref MâŠ‘Mâ€² â„“câ‰¼â„“) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , Tâ„“âŠ‘Tâ€²â„“ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢ref âŠ¢M â„“câ‰¼â„“ , âŠ¢ref âŠ¢Mâ€² â„“câ‰¼â„“ , âŠ‘-ty lâŠ‘l (âŠ‘-ref Tâ„“âŠ‘Tâ€²â„“) âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-ref? MâŠ‘Mâ€²) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , Tâ„“âŠ‘Tâ€²â„“ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢ref? âŠ¢M , âŠ¢ref? âŠ¢Mâ€² , âŠ‘-ty lâŠ‘l (âŠ‘-ref Tâ„“âŠ‘Tâ€²â„“) âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-ref?l MâŠ‘Mâ€² â„“câ‰¼â„“) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , Tâ„“âŠ‘Tâ€²â„“ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢ref? âŠ¢M , âŠ¢ref âŠ¢Mâ€² â„“câ‰¼â„“ , âŠ‘-ty lâŠ‘l (âŠ‘-ref Tâ„“âŠ‘Tâ€²â„“) âŸ©
{- Dereference -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-deref MâŠ‘Mâ€² eq eqâ€²) rewrite eq | eqâ€² =
  case cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² of Î» where
  âŸ¨ âŠ¢M , âŠ¢Mâ€² , âŠ‘-ty _ (âŠ‘-ref AâŠ‘Aâ€²) âŸ© â†’
    âŸ¨ âŠ¢deref âŠ¢M refl , âŠ¢deref âŠ¢Mâ€² refl , stamp-âŠ‘ AâŠ‘Aâ€² lâŠ‘l âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-deref! MâŠ‘Mâ€² eq eqâ€²) rewrite eq | eqâ€² =
  case cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² of Î» where
  âŸ¨ âŠ¢M , âŠ¢Mâ€² , âŠ‘-ty _ (âŠ‘-ref AâŠ‘Aâ€²) âŸ© â†’
    âŸ¨ âŠ¢deref! âŠ¢M refl , âŠ¢deref! âŠ¢Mâ€² refl , stamp-âŠ‘ AâŠ‘Aâ€² â‹†âŠ‘ âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-deref!l MâŠ‘Mâ€² eq eqâ€²) rewrite eq | eqâ€² =
  case cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² of Î» where
  âŸ¨ âŠ¢M , âŠ¢Mâ€² , âŠ‘-ty _ (âŠ‘-ref AâŠ‘Aâ€²) âŸ© â†’
    âŸ¨ âŠ¢deref! âŠ¢M refl , âŠ¢deref âŠ¢Mâ€² refl , stamp-âŠ‘ AâŠ‘Aâ€² â‹†âŠ‘ âŸ©
{- Assignment -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-assign LâŠ‘Lâ€² MâŠ‘Mâ€² â„“câ‰¼â„“Ì‚ â„“â‰¼â„“Ì‚) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢assign âŠ¢L âŠ¢M â„“câ‰¼â„“Ì‚ â„“â‰¼â„“Ì‚ , âŠ¢assign âŠ¢Lâ€² âŠ¢Mâ€² â„“câ‰¼â„“Ì‚ â„“â‰¼â„“Ì‚ , âŠ‘-ty lâŠ‘l âŠ‘-Î¹ âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-assign? LâŠ‘Lâ€² MâŠ‘Mâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢assign? âŠ¢L âŠ¢M , âŠ¢assign? âŠ¢Lâ€² âŠ¢Mâ€² , âŠ‘-ty lâŠ‘l âŠ‘-Î¹ âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-assign?l LâŠ‘Lâ€² MâŠ‘Mâ€²  â„“câ‰¼â„“Ì‚ â„“â‰¼â„“Ì‚) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _ âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢assign? âŠ¢L âŠ¢M , âŠ¢assign âŠ¢Lâ€² âŠ¢Mâ€² â„“câ‰¼â„“Ì‚ â„“â‰¼â„“Ì‚ , âŠ‘-ty lâŠ‘l âŠ‘-Î¹ âŸ©
{- Protection -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-prot MâŠ‘Mâ€² PCâŠ‘PCâ€² x xâ€² eq eqâ€²) rewrite eq | eqâ€² =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let prec = precâ†’âŠ‘ PCâŠ‘PCâ€² in
  let âŸ¨ âŠ¢PC , âŠ¢PCâ€² âŸ© = precâ†’âŠ¢ PCâŠ‘PCâ€² in
  âŸ¨ âŠ¢prot âŠ¢M âŠ¢PC x refl , âŠ¢prot âŠ¢Mâ€² âŠ¢PCâ€² xâ€² refl , stamp-âŠ‘ AâŠ‘Aâ€² lâŠ‘l âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-prot! MâŠ‘Mâ€² PCâŠ‘PCâ€² x xâ€² eq eqâ€² â„“â‰¼â„“â€²) rewrite eq | eqâ€² =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let prec = precâ†’âŠ‘ PCâŠ‘PCâ€² in
  let âŸ¨ âŠ¢PC , âŠ¢PCâ€² âŸ© = precâ†’âŠ¢ PCâŠ‘PCâ€² in
  âŸ¨ âŠ¢prot! âŠ¢M âŠ¢PC x refl , âŠ¢prot! âŠ¢Mâ€² âŠ¢PCâ€² xâ€² refl , stamp-âŠ‘ AâŠ‘Aâ€² â‹†âŠ‘ âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-prot!l MâŠ‘Mâ€² PCâŠ‘PCâ€² x xâ€² eq eqâ€² â„“â‰¼â„“â€²) rewrite eq | eqâ€² =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  let prec = precâ†’âŠ‘ PCâŠ‘PCâ€² in
  let âŸ¨ âŠ¢PC , âŠ¢PCâ€² âŸ© = precâ†’âŠ¢ PCâŠ‘PCâ€² in
  âŸ¨ âŠ¢prot! âŠ¢M âŠ¢PC x refl , âŠ¢prot âŠ¢Mâ€² âŠ¢PCâ€² xâ€² refl , stamp-âŠ‘ AâŠ‘Aâ€² â‹†âŠ‘ âŸ©
{- Cast -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-cast MâŠ‘Mâ€² câŠ‘câ€²) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢cast âŠ¢M , âŠ¢cast âŠ¢Mâ€² , projâ‚‚ (coercion-precâ†’âŠ‘ câŠ‘câ€²) âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-castl MâŠ‘Mâ€² câŠ‘Aâ€²) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢cast âŠ¢M , âŠ¢Mâ€² , projâ‚‚ (coercion-prec-leftâ†’âŠ‘ câŠ‘Aâ€²) âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-castr MâŠ‘Mâ€² AâŠ‘câ€²) =
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , AâŠ‘Aâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  âŸ¨ âŠ¢M , âŠ¢cast âŠ¢Mâ€² , projâ‚‚ (coercion-prec-rightâ†’âŠ‘ AâŠ‘câ€²) âŸ©
{- Blame -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-blame âŠ¢M AâŠ‘Aâ€²) =
  âŸ¨ âŠ¢M , âŠ¢blame , AâŠ‘Aâ€² âŸ©


{- â— is not in the precision relation -}
_â‹¤â— : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€² A Aâ€²} M
  â†’ Â¬ (Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ â— â‡ A âŠ‘ Aâ€²)
((M âŸ¨ c âŸ©) â‹¤â—) (âŠ‘-castl MâŠ‘â— câŠ‘Aâ€²) = (M â‹¤â—) MâŠ‘â—

â—â‹¤_ : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€² A Aâ€²} M
  â†’ Â¬ (Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ â— âŠ‘ M â‡ A âŠ‘ Aâ€²)
(â—â‹¤ (M âŸ¨ c âŸ©)) (âŠ‘-castr â—âŠ‘M AâŠ‘c) = (â—â‹¤ M) â—âŠ‘M


data _Í¾_Í¾_âŠ¢_âŠ‘_ : âˆ€ (Î£ Î£â€² : HeapContext) â†’ âˆ€ â„“ â†’ (Î¼ Î¼â€² : HalfHeap) â†’ Set where

  âŠ‘-âˆ… : âˆ€ {Î£ Î£â€² â„“} â†’ Î£ Í¾ Î£â€² Í¾ â„“ âŠ¢ [] âŠ‘ []

  âŠ‘-âˆ· : âˆ€ {Î£ Î£â€² â„“} {Î¼ Î¼â€² n} {V Vâ€² v vâ€²} {T Tâ€²}
    â†’ Î£ Í¾ Î£â€² Í¾ â„“ âŠ¢ Î¼ âŠ‘ Î¼â€²
    â†’ [] Í¾ [] âˆ£ Î£ Í¾ Î£â€² âˆ£ l low Í¾ l low âˆ£ low Í¾ low âŠ¢ V âŠ‘ Vâ€² â‡ T of l â„“ âŠ‘ Tâ€² of l â„“
      --------------------------------------------------------------------------------
    â†’ Î£ Í¾ Î£â€² Í¾ â„“ âŠ¢ (âŸ¨ n , V & v âŸ© âˆ· Î¼) âŠ‘ (âŸ¨ n , Vâ€² & vâ€² âŸ© âˆ· Î¼â€²)

_Í¾_âŠ¢_âŠ‘_ : âˆ€ (Î£ Î£â€² : HeapContext) (Î¼ Î¼â€² : Heap) â†’ Set
Î£ Í¾ Î£â€² âŠ¢ âŸ¨ Î¼á´¸ , Î¼á´´ âŸ© âŠ‘ âŸ¨ Î¼á´¸â€² , Î¼á´´â€² âŸ© = (Î£ Í¾ Î£â€² Í¾ low âŠ¢ Î¼á´¸ âŠ‘ Î¼á´¸â€²) Ã— (Î£ Í¾ Î£â€² Í¾ high âŠ¢ Î¼á´´ âŠ‘ Î¼á´´â€²)


value-âŠ‘-pc : âˆ€ {Î“ Î“â€² Î£ Î£â€² gcâ‚ gcâ‚â€² gcâ‚‚ gcâ‚‚â€² â„“vâ‚ â„“vâ‚â€² â„“vâ‚‚ â„“vâ‚‚â€²} {A B} {V W}
  â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gcâ‚ Í¾ gcâ‚â€² âˆ£ â„“vâ‚ Í¾ â„“vâ‚â€² âŠ¢ V âŠ‘ W â‡ A âŠ‘ B
  â†’ Value V
  â†’ Value W
    -------------------------------------------------------------
  â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gcâ‚‚ Í¾ gcâ‚‚â€² âˆ£ â„“vâ‚‚ Í¾ â„“vâ‚‚â€² âŠ¢ V âŠ‘ W â‡ A âŠ‘ B
value-âŠ‘-pc âŠ‘-const (V-raw V-const) (V-raw V-const) = âŠ‘-const
value-âŠ‘-pc (âŠ‘-addr x y) (V-raw V-addr) (V-raw V-addr) = âŠ‘-addr x y
value-âŠ‘-pc (âŠ‘-lam x y z) (V-raw V-Æ›) (V-raw V-Æ›) = âŠ‘-lam x y z
value-âŠ‘-pc (âŠ‘-castr VâŠ‘W AâŠ‘câ€²) (V-raw v) (V-cast vâ€² _) =
  âŠ‘-castr (value-âŠ‘-pc VâŠ‘W (V-raw v) (V-raw vâ€²)) AâŠ‘câ€²
value-âŠ‘-pc (âŠ‘-castl VâŠ‘W câŠ‘B) (V-cast v _) (V-raw w) =
  âŠ‘-castl (value-âŠ‘-pc VâŠ‘W (V-raw v) (V-raw w)) câŠ‘B
value-âŠ‘-pc (âŠ‘-cast VâŠ‘W câŠ‘câ€²) (V-cast v _) (V-cast w _) =
  âŠ‘-cast (value-âŠ‘-pc VâŠ‘W (V-raw v) (V-raw w)) câŠ‘câ€²
value-âŠ‘-pc (âŠ‘-castl VâŠ‘W câŠ‘B) (V-cast v _) (V-cast w i) =
  âŠ‘-castl (value-âŠ‘-pc VâŠ‘W (V-raw v) (V-cast w i)) câŠ‘B
value-âŠ‘-pc (âŠ‘-castr VâŠ‘W AâŠ‘câ€²) (V-cast v i) (V-cast w _) =
  âŠ‘-castr (value-âŠ‘-pc VâŠ‘W (V-cast v i) (V-raw w)) AâŠ‘câ€²
value-âŠ‘-pc VâŠ‘W v V-â— = contradiction VâŠ‘W (_ â‹¤â—)
value-âŠ‘-pc VâŠ‘W V-â— w = contradiction VâŠ‘W (â—â‹¤ _)
