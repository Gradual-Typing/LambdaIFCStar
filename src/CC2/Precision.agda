{- Precision relation of CC2 -}

open import Common.Types

module CC2.Precision where

open import Data.Nat
open import Data.Unit using (âŠ¤; tt)
open import Data.Bool using (true; false) renaming (Bool to ğ”¹)
open import Data.List
open import Data.Product using (_Ã—_; âˆƒ-syntax; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Data.Maybe
open import Relation.Nullary using (Â¬_; Dec; yes; no)
open import Relation.Nullary.Negation using (contradiction)
open import Relation.Binary.PropositionalEquality using (_â‰¡_; refl; trans; subst; substâ‚‚; sym)
open import Function using (case_of_)

open import Syntax
open import Common.Utils
open import Memory.HeapContext
open import CC2.Statics


data _âŠ‘*_ : (Î“ Î“â€² : Context) â†’ Set where

  âŠ‘*-âˆ… : [] âŠ‘* []

  âŠ‘*-âˆ· : âˆ€ {Î“ Î“â€² A Aâ€²} â†’ A âŠ‘ Aâ€² â†’ Î“ âŠ‘* Î“â€² â†’ (A âˆ· Î“) âŠ‘* (Aâ€² âˆ· Î“â€²)


âŠ‘*â†’âŠ‘ : âˆ€ {Î“ Î“â€² A Aâ€² x} â†’ Î“ âŠ‘* Î“â€² â†’ Î“ âˆ‹ x â¦‚ A â†’ Î“â€² âˆ‹ x â¦‚ Aâ€² â†’ A âŠ‘ Aâ€²
âŠ‘*â†’âŠ‘ {x = 0}     (âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€²) refl refl = AâŠ‘Aâ€²
âŠ‘*â†’âŠ‘ {x = suc x} (âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€²) Î“âˆ‹x  Î“â€²âˆ‹x = âŠ‘*â†’âŠ‘ Î“âŠ‘Î“â€² Î“âˆ‹x Î“â€²âˆ‹x


data _âŠ‘â‚•_ : (Î£ Î£â€² : HalfHeapContext) â†’ Set where

  âŠ‘-âˆ… : [] âŠ‘â‚• []

  âŠ‘-âˆ· : âˆ€ {Î£ Î£â€² T Tâ€² n} â†’ T âŠ‘áµ£ Tâ€² â†’ Î£ âŠ‘â‚• Î£â€² â†’ (âŸ¨ n , T âŸ© âˆ· Î£) âŠ‘â‚• (âŸ¨ n , Tâ€² âŸ© âˆ· Î£â€²)

_âŠ‘â‚˜_ : (Î£ Î£â€² : HeapContext) â†’ Set
âŸ¨ Î£á´¸ , Î£á´´ âŸ© âŠ‘â‚˜ âŸ¨ Î£á´¸â€² , Î£á´´â€² âŸ© = (Î£á´¸ âŠ‘â‚• Î£á´¸â€²) Ã— (Î£á´´ âŠ‘â‚• Î£á´´â€²)

âŠ‘â‚•â†’âŠ‘ : âˆ€ {Î£ Î£â€² T Tâ€² n}
  â†’ Î£ âŠ‘â‚• Î£â€²
  â†’ find _â‰Ÿ_ Î£  n â‰¡ just T
  â†’ find _â‰Ÿ_ Î£â€² n â‰¡ just Tâ€²
  â†’ T âŠ‘áµ£ Tâ€²
âŠ‘â‚•â†’âŠ‘ {âŸ¨ nâ‚€ , T âŸ© âˆ· _} {âŸ¨ nâ‚€ , Tâ€² âŸ© âˆ· _} {n = n} (âŠ‘-âˆ· TâŠ‘Tâ€² Î£âŠ‘Î£â€²) eq eqâ€²
  with n â‰Ÿ nâ‚€
... | no _ = âŠ‘â‚•â†’âŠ‘ Î£âŠ‘Î£â€² eq eqâ€²
... | yes refl with eq | eqâ€²
... | refl | refl = TâŠ‘Tâ€²

âŠ‘â‚˜â†’âŠ‘ : âˆ€ {Î£ Î£â€² T Tâ€² n â„“Ì‚}
  â†’ Î£ âŠ‘â‚˜ Î£â€²
  â†’ let a = aâŸ¦ â„“Ì‚ âŸ§ n in
     lookup-Î£ Î£  a â‰¡ just T
  â†’ lookup-Î£ Î£â€² a â‰¡ just Tâ€²
  â†’ T âŠ‘áµ£ Tâ€²
âŠ‘â‚˜â†’âŠ‘ {â„“Ì‚ = low}  âŸ¨ Î£á´¸âŠ‘ , _ âŸ© Î£aâ‰¡T Î£â€²aâ‰¡Tâ€² = âŠ‘â‚•â†’âŠ‘ Î£á´¸âŠ‘ Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²
âŠ‘â‚˜â†’âŠ‘ {â„“Ì‚ = high} âŸ¨ _ , Î£á´´âŠ‘ âŸ© Î£aâ‰¡T Î£â€²aâ‰¡Tâ€² = âŠ‘â‚•â†’âŠ‘ Î£á´´âŠ‘ Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²


infix 4 _Í¾_âˆ£_Í¾_âˆ£_Í¾_âˆ£_Í¾_âŠ¢_âŠ‘_â‡_âŠ‘_

data _Í¾_âˆ£_Í¾_âˆ£_Í¾_âˆ£_Í¾_âŠ¢_âŠ‘_â‡_âŠ‘_ : (Î“ Î“â€² : Context) (Î£ Î£â€² : HeapContext)
  (g gâ€² : Label) (â„“ â„“â€² : StaticLabel) (M Mâ€² : Term) (A Aâ€² : Type) â†’ Set where

  âŠ‘-var : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€² A Aâ€² x}
    â†’ Î“  âˆ‹ x â¦‚ A
    â†’ Î“â€² âˆ‹ x â¦‚ Aâ€²
      ---------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ ` x âŠ‘ ` x â‡ A âŠ‘ Aâ€²

  âŠ‘-const : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€² Î¹ â„“} {k : rep Î¹}
      ---------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ $ k âŠ‘ $ k
         â‡ ` Î¹ of l â„“ âŠ‘ ` Î¹ of l â„“

  âŠ‘-addr : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {n â„“ â„“Ì‚ T Tâ€²}
    â†’ lookup-Î£ Î£  (aâŸ¦ â„“Ì‚ âŸ§ n) â‰¡ just T
    â†’ lookup-Î£ Î£â€² (aâŸ¦ â„“Ì‚ âŸ§ n) â‰¡ just Tâ€²
      -------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ addr n âŠ‘ addr n
         â‡ Ref (T of l â„“Ì‚) of l â„“ âŠ‘ Ref (Tâ€² of l â„“Ì‚) of l â„“

  âŠ‘-lam : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {N Nâ€²} {g gâ€² A Aâ€² B Bâ€² â„“}
    â†’ g âŠ‘â‚— gâ€²
    â†’ A âŠ‘  Aâ€²
    â†’ (âˆ€ {â„“v â„“vâ€²} â†’ A âˆ· Î“ Í¾ Aâ€² âˆ· Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ g Í¾ gâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ N âŠ‘ Nâ€² â‡ B âŠ‘ Bâ€²)
      --------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ Æ› N âŠ‘ Æ› Nâ€²
         â‡ âŸ¦ g âŸ§ A â‡’ B of l â„“ âŠ‘ âŸ¦ gâ€² âŸ§ Aâ€² â‡’ Bâ€² of l â„“

  âŠ‘-app : âˆ€ {Î“ Î“â€² Î£ Î£â€² â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {A Aâ€² B Bâ€² C Câ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ âŸ¦ l (â„“c â‹ â„“) âŸ§ A â‡’ B of l â„“ âŠ‘ âŸ¦ l (â„“c â‹ â„“) âŸ§ Aâ€² â‡’ Bâ€² of l â„“
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ C  â‰¡ stamp B  (l â„“)
    â†’ Câ€² â‰¡ stamp Bâ€² (l â„“)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ l â„“c Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ app L M A B â„“ âŠ‘ app Lâ€² Mâ€² Aâ€² Bâ€² â„“ â‡ C âŠ‘ Câ€²

  âŠ‘-app! : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {A Aâ€² B Bâ€² C Câ€²}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ âŸ¦ â‹† âŸ§ A â‡’ B of â‹† âŠ‘ âŸ¦ â‹† âŸ§ Aâ€² â‡’ Bâ€² of â‹†
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ C  â‰¡ stamp B  â‹†
    â†’ Câ€² â‰¡ stamp Bâ€² â‹†
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ app! L M A B âŠ‘ app! Lâ€² Mâ€² Aâ€² Bâ€² â‡ C âŠ‘ Câ€²

  âŠ‘-app!l : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc â„“c â„“v â„“vâ€²} {L Lâ€² M Mâ€²} {A Aâ€² B Bâ€² C Câ€² â„“}
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ L âŠ‘ Lâ€²
         â‡ âŸ¦ â‹† âŸ§ A â‡’ B of â‹† âŠ‘ âŸ¦ l (â„“c â‹ â„“) âŸ§ Aâ€² â‡’ Bâ€² of l â„“
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    â†’ C  â‰¡ stamp B     â‹†
    â†’ Câ€² â‰¡ stamp Bâ€² (l â„“)
      -------------------------------------------------------------------------------------------
    â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ l â„“c âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ app! L M A B âŠ‘ app Lâ€² Mâ€² Aâ€² Bâ€² â„“ â‡ C âŠ‘ Câ€²


{- The term precision relation implies that both terms are well-typed.
   Furthermore, their types are related by type precision. -}
cc-prec-inv : âˆ€ {Î“ Î“â€² Î£ Î£â€² gc gcâ€² â„“v â„“vâ€²} {M Mâ€²} {A Aâ€²}
  â†’ Î“ âŠ‘* Î“â€²
  â†’ Î£ âŠ‘â‚˜ Î£â€²
  â†’ Î“ Í¾ Î“â€² âˆ£ Î£ Í¾ Î£â€² âˆ£ gc Í¾ gcâ€² âˆ£ â„“v Í¾ â„“vâ€² âŠ¢ M âŠ‘ Mâ€² â‡ A âŠ‘ Aâ€²
    -------------------------------------------------------------
  â†’ Î“  Í¾ Î£  Í¾ gc  Í¾ â„“v  âŠ¢ M  â‡ A    Ã—
     Î“â€² Í¾ Î£â€² Í¾ gcâ€² Í¾ â„“vâ€² âŠ¢ Mâ€² â‡ Aâ€²   Ã—
     A âŠ‘ Aâ€²
cc-prec-inv Î“âŠ‘Î“â€² _ (âŠ‘-var Î“âˆ‹x Î“â€²âˆ‹x) = âŸ¨ âŠ¢var Î“âˆ‹x , âŠ¢var Î“â€²âˆ‹x , âŠ‘*â†’âŠ‘ Î“âŠ‘Î“â€² Î“âˆ‹x Î“â€²âˆ‹x âŸ©
cc-prec-inv _ _ âŠ‘-const = âŸ¨ âŠ¢const , âŠ¢const , âŠ‘-ty lâŠ‘l âŠ‘-Î¹ âŸ©
cc-prec-inv _ Î£âŠ‘Î£â€² (âŠ‘-addr {n = n} {â„“} {â„“Ì‚} Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²) =
  âŸ¨ âŠ¢addr Î£aâ‰¡T , âŠ¢addr Î£â€²aâ‰¡Tâ€² , âŠ‘-ty lâŠ‘l (âŠ‘-ref (âŠ‘-ty lâŠ‘l (âŠ‘â‚˜â†’âŠ‘ {n = n} {â„“Ì‚} Î£âŠ‘Î£â€² Î£aâ‰¡T Î£â€²aâ‰¡Tâ€²))) âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-lam gâŠ‘gâ€² AâŠ‘Aâ€² NâŠ‘Nâ€²) =
  let prec* = âŠ‘*-âˆ· AâŠ‘Aâ€² Î“âŠ‘Î“â€² in
  âŸ¨ âŠ¢lam (projâ‚        (cc-prec-inv {â„“vâ€² = low} prec* Î£âŠ‘Î£â€² NâŠ‘Nâ€²))  ,
    âŠ¢lam (projâ‚ (projâ‚‚ (cc-prec-inv {â„“v  = low} prec* Î£âŠ‘Î£â€² NâŠ‘Nâ€²))) ,
    âŠ‘-ty lâŠ‘l (âŠ‘-fun gâŠ‘gâ€² AâŠ‘Aâ€² (projâ‚‚ (projâ‚‚ (cc-prec-inv {â„“v = low} {low} prec* Î£âŠ‘Î£â€² NâŠ‘Nâ€²)))) âŸ©
{- Application -}
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-app {C = C} {Câ€²} LâŠ‘Lâ€² MâŠ‘Mâ€² eq eqâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , Aâ†’BâŠ‘Aâ€²â†’Bâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _           âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  case Aâ†’BâŠ‘Aâ€²â†’Bâ€² of Î» where
  (âŠ‘-ty lâŠ‘l (âŠ‘-fun lâŠ‘l AâŠ‘Aâ€² BâŠ‘Bâ€²)) â†’
    let CâŠ‘Câ€² : C âŠ‘ Câ€²
        CâŠ‘Câ€² = substâ‚‚ _âŠ‘_ (sym eq) (sym eqâ€²) (stamp-âŠ‘ BâŠ‘Bâ€² lâŠ‘l) in
    âŸ¨ âŠ¢app âŠ¢L âŠ¢M eq , âŠ¢app âŠ¢Lâ€² âŠ¢Mâ€² eqâ€² , CâŠ‘Câ€² âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-app! {C = C} {Câ€²} LâŠ‘Lâ€² MâŠ‘Mâ€² eq eqâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , Aâ†’BâŠ‘Aâ€²â†’Bâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _           âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  case Aâ†’BâŠ‘Aâ€²â†’Bâ€² of Î» where
  (âŠ‘-ty â‹†âŠ‘ (âŠ‘-fun â‹†âŠ‘ AâŠ‘Aâ€² BâŠ‘Bâ€²)) â†’
    let CâŠ‘Câ€² : C âŠ‘ Câ€²
        CâŠ‘Câ€² = substâ‚‚ _âŠ‘_ (sym eq) (sym eqâ€²) (stamp-âŠ‘ BâŠ‘Bâ€² â‹†âŠ‘) in
    âŸ¨ âŠ¢app! âŠ¢L âŠ¢M eq , âŠ¢app! âŠ¢Lâ€² âŠ¢Mâ€² eqâ€² , CâŠ‘Câ€² âŸ©
cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² (âŠ‘-app!l {C = C} {Câ€²} LâŠ‘Lâ€² MâŠ‘Mâ€² eq eqâ€²) =
  let âŸ¨ âŠ¢L , âŠ¢Lâ€² , Aâ†’BâŠ‘Aâ€²â†’Bâ€² âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² LâŠ‘Lâ€² in
  let âŸ¨ âŠ¢M , âŠ¢Mâ€² , _           âŸ© = cc-prec-inv Î“âŠ‘Î“â€² Î£âŠ‘Î£â€² MâŠ‘Mâ€² in
  case Aâ†’BâŠ‘Aâ€²â†’Bâ€² of Î» where
  (âŠ‘-ty â‹†âŠ‘ (âŠ‘-fun â‹†âŠ‘ AâŠ‘Aâ€² BâŠ‘Bâ€²)) â†’
    let CâŠ‘Câ€² : C âŠ‘ Câ€²
        CâŠ‘Câ€² = substâ‚‚ _âŠ‘_ (sym eq) (sym eqâ€²) (stamp-âŠ‘ BâŠ‘Bâ€² â‹†âŠ‘) in
    âŸ¨ âŠ¢app! âŠ¢L âŠ¢M eq , âŠ¢app âŠ¢Lâ€² âŠ¢Mâ€² eqâ€² , CâŠ‘Câ€² âŸ©
