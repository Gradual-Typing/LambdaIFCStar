++++ Coercions on Labels ++++

câ‚— , dâ‚— ::= id(g) | â†‘ | â„“ ! | â„“ ?áµ– | c ; d | âŠ¥áµ–

label coercion typing âŠ¢ câ‚— : gâ‚ â‡’ gâ‚‚

-------------------    ---------------------
 âŠ¢ id(g) : g â‡’ g       âŠ¢ â†‘ : low â‡’ high

------------------    -----------------
  âŠ¢ â„“ ! : â„“ â‡’ â‹†       âŠ¢ â„“ ?áµ– : â‹† â‡’ â„“

 âŠ¢ c : gâ‚ â‡’ gâ‚‚  âŠ¢ d : gâ‚‚ â‡’ gâ‚ƒ
--------------------------------   -------------------
     âŠ¢ c ; d : gâ‚ â‡’ gâ‚ƒ              âŠ¢ âŠ¥áµ– : gâ‚ â‡’ gâ‚‚


label expressions (representation of our runtime PC):

e ::= â„“ | e âŸ¨ câ‚— âŸ© | err p

ğ“‹ ::= â„“ | â„“ âŸ¨ â„“ ! âŸ©

label expression reduction (similar to Î»C):

       e â€”â†’ eâ€²
--------------------------
  e âŸ¨ c âŸ© â€”â†’ eâ€² âŸ¨ c âŸ©

---------------------------------
  (err p) âŸ¨ c âŸ© â€”â†’ err p

ğ“‹ âŸ¨ id(g) âŸ©              â€”â†’ ğ“‹
low âŸ¨ â†‘ âŸ©               â€”â†’ high
ğ“‹ âŸ¨ câ‚— ; dâ‚— âŸ©            â€”â†’ ğ“‹ âŸ¨ câ‚— âŸ© âŸ¨ dâ‚— âŸ©
ğ“‹ âŸ¨ â„“ !    âŸ© âŸ¨ â„“ ?áµ–    âŸ© â€”â†’ â„“
ğ“‹ âŸ¨ low !  âŸ© âŸ¨ high ?áµ– âŸ© â€”â†’ high
ğ“‹ âŸ¨ high ! âŸ© âŸ¨ low ?áµ– âŸ©  â€”â†’ err p
ğ“‹ âŸ¨ âŠ¥áµ– âŸ©                 â€”â†’ err p


label coercion equational theory (similar to Î»S):

id(g) ; câ‚— = câ‚—           câ‚— ; id(g) = câ‚—

âŠ¥áµ–    ; câ‚— = âŠ¥áµ–           câ‚— ; âŠ¥áµ–    = âŠ¥áµ–

â„“    ! ; â„“    ?áµ– = id(â„“)
low  ! ; high ?áµ– = â†‘
high ! ; low  ?áµ– = âŠ¥áµ–

(câ‚ ; câ‚‚) ; câ‚ƒ = câ‚ ; (câ‚‚ ; câ‚ƒ)

composition function câ‚— â¨Ÿ dâ‚— is based on the rules above

normal forms of coercions (invariant, no subtype coercion):

câ‚—â¿á¶ i ::= âŠ¥áµ– | id(g) | â„“ ! | â„“ ?áµ– | â„“ ?áµ– ; â„“ !

normal forms of coercions:

câ‚—â¿á¶  ::= âŠ¥áµ– | id(g) | â†‘ | â„“ ! | â„“ ?áµ– | â†‘ ; high !
       | low ?áµ– ; â†‘ | â„“ ?áµ– ; â„“ ! | low ?áµ– ; â†‘ ; high !

++++ Coercions on Values ++++

between raw types: cáµ£, dáµ£ ::= id(Î¹) | (dâ‚— | c â†’ d) | (dâ‚— | in: c; out: d)
between types:     c, d   ::= (cáµ£ | câ‚—)

composition, note that the `dâ‚—`s in function and reference coercions are contravariant:

id(Î¹) â¨Ÿ id(Î¹) = id(Î¹)
(dâ‚—â‚ | câ‚ â†’ dâ‚) â¨Ÿ (dâ‚—â‚‚ | câ‚‚ â†’ dâ‚‚) =
     (dâ‚—â‚‚ â¨Ÿ dâ‚—â‚ | (câ‚‚ â¨Ÿ câ‚) â†’ (dâ‚ â¨Ÿ dâ‚‚))
(dâ‚—â‚ | in: câ‚; out: dâ‚) â¨Ÿ (dâ‚—â‚‚ | in: câ‚‚; out: dâ‚‚) =
     (dâ‚—â‚‚ â¨Ÿ dâ‚—â‚ | in: (câ‚‚ â¨Ÿ câ‚); out: (dâ‚ â¨Ÿ dâ‚‚))

(cáµ£â‚ | câ‚—â‚) â¨Ÿ (cáµ£â‚‚ | câ‚—â‚‚) = (cáµ£â‚ â¨Ÿ cáµ£â‚‚ | câ‚—â‚ â¨Ÿ câ‚—â‚‚)

normal forms of coercions on values:

cáµ£â¿á¶  ::= id(Î¹) | ( dâ‚—â¿á¶  | câ¿á¶  â†’ dâ¿á¶ ) | (dâ‚—â¿á¶ i | in: câ¿á¶ ; out: dâ¿á¶ )
câ¿á¶   ::= (cáµ£â¿á¶  | câ‚—â¿á¶ )

typing rules of coercions on values âŠ¢ c : A :

            âŠ¢ câ‚— : gâ‚ â‡’ gâ‚‚
----------------------------------------
 âŠ¢ ( id(Î¹) | câ‚— ) : Î¹ of gâ‚ â‡’ Î¹ of gâ‚‚


             âŠ¢ dâ‚— : gá¶œâ‚‚ â‡’ gá¶œâ‚       âŠ¢ câ‚— : gâ‚ â‡’ gâ‚‚
             âŠ¢ c  : C   â‡’ A         âŠ¢ d  : B  â‡’ D
------------------------------------------------------------------------
 âŠ¢ ( dâ‚— | c â†’ d | câ‚— ) : âŸ¦ gá¶œâ‚ âŸ§ A â†’ B of gâ‚ â‡’ âŸ¦ gá¶œâ‚‚ âŸ§ C â†’ D of gâ‚‚


                  âŠ¢ dâ‚— : gÌ‚â‚‚ â‡’ gÌ‚â‚   âŠ¢ câ‚— : gâ‚ â‡’ gâ‚‚
      âŠ¢ c : (T of gÌ‚â‚‚) â‡’ (S of gÌ‚â‚) âŠ¢ d : (S of gÌ‚â‚) â‡’ (T of gÌ‚â‚‚)
----------------------------------------------------------------------------
 âŠ¢ ( dâ‚— | in: c; out: d | câ‚—) : Ref (S of gÌ‚â‚) of gâ‚ â‡’ Ref (T of gÌ‚â‚‚) of gâ‚‚
