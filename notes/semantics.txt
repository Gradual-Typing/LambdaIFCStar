PC expressions e_pc ::= low âŸ¨ cÌ…  âŸ©
PC             v_pc ::= low âŸ¨ cÌ…â‚™ âŸ©

TODO expressions

raw values   Váµ£, Wáµ£ ::= k | Æ› N | addr n
values       V, W   ::= Váµ£ | Váµ£ âŸ¨ cáµ¢ âŸ©


F ::= app â–¡ M â„“á¶œ A B â„“ | app V â–¡ â„“á¶œ A B â„“
    | app! â–¡ M A B g | app! V â–¡ A B g
    | if â–¡ A â„“ M N | if! â–¡ A g M N
    | let â–¡ N | refâŸ¦ â„“ âŸ§ T â–¡ | ref?âŸ¦ â„“ âŸ§ T â–¡ p | ! â–¡
    | assign  â–¡ M T â„“Ì‚ â„“ | assign  V â–¡ T â„“Ì‚ â„“
    | assign? â–¡ M T p   | assign? V â–¡ T p
    | â–¡ âŸ¨ c âŸ©

       M âˆ£ Î¼ âˆ£ v_pc â€”â†’ N âˆ£ Î¼â€²
---------------------------------------
plug M F âˆ£ Î¼ âˆ£ v_pc â€”â†’ plug N F âˆ£ Î¼â€²


plug (blame p) F âˆ£ Î¼ âˆ£ v_pc â€”â†’ blame p âˆ£ Î¼

                    (stamp cÌ…â‚™ â„“) â¨¾ . â‡’ â„“á¶œ â€”â†  cÌ…â‚™â€²
-------------------------------------------------------------------------------
app (Æ› N) V â„“á¶œ A B â„“ âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™ âŸ© â€”â†’ â¦ƒ low âŸ¨ cÌ…â‚™ âŸ© â¦„ (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


          ((stamp cÌ…â‚™â€² â„“) â¨¾ . â‡’ â„“á¶œ) â¨Ÿ dÌ…â‚™ â€”â†  cÌ…â‚™â€³
-------------------------------------------------------------------------------
app ((Æ› N) âŸ¨ dÌ…â‚™ | c â†’ d | cÌ…â‚™ âŸ©) V â„“á¶œ A B â„“ âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™â€² âŸ© â€”â†’
      let (V âŸ¨ c âŸ©) in (â¦ƒ ğ“‹ â¦„ (N âŸ¨ d âŸ©) âŸª â„“ âŸ«) âˆ£ Î¼


         (stamp cÌ…â‚™ â„“) â¨¾ . â‡’ â‹† â€”â†  cÌ…â‚™â€²
------------------------------------------------------------
app! (Æ› N) V A B â„“ âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™ âŸ© â€”â†’ â¦ƒ low âŸ¨ cÌ…â‚™â€² âŸ© â¦„ (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


                      â„“ = âˆ¥ câ‚— âˆ¥
       stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹â€²
-----------------------------------------------------------
app! ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V A B g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’
    let (V âŸ¨ c âŸ©) in (â¦ƒ ğ“‹â€² â¦„ (N âŸ¨ d âŸ©) âŸª â„“ âŸ«) âˆ£ Î¼

                      â„“ = âˆ¥ câ‚— âˆ¥
       stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  err p
-----------------------------------------------------------------
app! ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V A B g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p

Note: `dâ‚—` may contain a projection


if true A â„“ M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ pc â‹ â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼

if (true âŸ¨ id(ğ”¹) | â†‘ âŸ©) A high M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ high â¦„ M âŸª high âŸ« âˆ£ Î¼


if! true A â„“ M N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ stamp ğ“‹ â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼

Note: from typing, ğ“‹ must be `â„“á¶œ âŸ¨ â„“á¶œ ! âŸ©` for some â„“á¶œ


                         â„“ = âˆ¥ câ‚— âˆ¥
             stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© â€”â†  ğ“‹â€²
--------------------------------------------------------------------
if! (true âŸ¨ id(ğ”¹) | câ‚— âŸ©) A g M N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ M âŸª â„“ âŸ« âˆ£ Î¼


let V A N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ N[ V ] âˆ£ Î¼


refâŸ¦ â„“ âŸ§ T V âˆ£ Î¼ âˆ£ pc â€”â†’ addr n â„“ âˆ£ Î¼(â„“ â†¦ Î¼(â„“)(n â†¦ V))   , n is fresh

                    â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  ğ“‹â€²
-------------------------------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T V p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ addr n â„“ âˆ£ Î¼(â„“ â†¦ Î¼(â„“)(n â†¦ V)) , n is fresh

Note: implies that â„“â€² â‰¼ â„“

                    â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  err p
---------------------------------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T V p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ blame p âˆ£ Î¼   , n is fresh


                   Î¼(â„“Ì‚)(n) = V
-----------------------------------------------------------
! (addr n â„“Ì‚) (T of â„“Ì‚) â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹ â¦„ V âŸª â„“ âŸ« âˆ£ Î¼

                          â„“ = âˆ¥ câ‚— âˆ¥
                          Î¼(â„“Ì‚)(n) = V
-----------------------------------------------------------------------------
! (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) A g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹ â¦„ (V âŸ¨ d âŸ©) âŸª â„“ âŸ«


assign (addr n â„“Ì‚) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ unit âˆ£ Î¼(â„“Ì‚ â†¦ Î¼(â„“Ì‚)(n â†¦ V))

assign (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ pc
   â€”â†’ unit âˆ£ Î¼(â„“Ì‚ â†¦ Î¼(â„“Ì‚)(n â†¦ VâŸ¨câŸ©))

Note: in this case dâ‚— must be id(â„“Ì‚). from typing we know pc â‹ â„“ â‰¼ â„“Ì‚, which
implies that the assignment is safe

                         â„“ = âˆ¥ câ‚— âˆ¥
          (stamp ğ“‹ â„“) âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†’ ğ“‹â€²
-----------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T p âˆ£ Î¼ | ğ“‹ â€”â†’
        unit | Î¼(â„“Ì‚ â†¦ Î¼(â„“Ì‚)(n â†¦ VâŸ¨câŸ©))

âŠ¢ dâ‚— : â‹† â‡’ â„“Ì‚

                         â„“ = âˆ¥ câ‚— âˆ¥
          stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†’ err p
----------------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T p âˆ£ Î¼ | ğ“‹ â€”â†’ blame p

Note: `dâ‚—` is projecting, where the blame label `p` comes from


V âŸ¨ c âŸ© âŸ¨ d âŸ© âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ V âŸ¨ c â¨Ÿ d âŸ© âˆ£ Î¼


V âŸ¨ cáµ£ | âŠ¥áµ– âŸ© âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p âˆ£ Î¼


             M âˆ£ Î¼ âˆ£ ğ“‹â€² â€”â†’ N âˆ£ Î¼â€²
---------------------------------------------------
â¦ƒ ğ“‹â€² â¦„ M âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ N âŸª â„“ âŸ« âˆ£ Î¼â€²

â¦ƒ ğ“‹â€² â¦„ blame p âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p âˆ£ Î¼

â¦ƒ ğ“‹â€² â¦„ V âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ stamp V â„“ âˆ£ Î¼
