PC           pc ::= low âŸ¨ cÌ…â‚™ âŸ©

expressions
M ::= app L M A B â„“ | app! L M A B g
    | if  L A â„“ M N | if!  L A g M N
    | let M N | refâŸ¦ â„“ âŸ§ T M | ref?âŸ¦ â„“ âŸ§ T M p | ! M
    | assign  L M T â„“Ì‚ â„“ | assign? L M T p
    | â–¡ âŸ¨ c âŸ© | â¦ƒ pc â¦„ M âŸª â„“ âŸ« | { cÌ… } M âŸª â„“ âŸ« | blame p

raw values   Váµ£, Wáµ£ ::= k  | Æ› N | addr n â„“
values       V, W   ::= Váµ£ | Váµ£ âŸ¨ cáµ¢ âŸ©


F ::= app  â–¡ M A B â„“ | app  V â–¡ A B â„“
    | app! â–¡ M A B g | app! V â–¡ A B g
    | if   â–¡ A â„“ M N | if!  â–¡ A g M N
    | let â–¡ N | refâŸ¦ â„“ âŸ§ T â–¡ | ref?âŸ¦ â„“ âŸ§ T â–¡ p | ! â–¡
    | assign  â–¡ M T â„“Ì‚ â„“ | assign  V â–¡ T â„“Ì‚ â„“
    | assign? â–¡ M T p   | assign? V â–¡ T p
    | â–¡ âŸ¨ c âŸ©


         M âˆ£ Î¼ âˆ£ pc â€”â†’ N âˆ£ Î¼â€²
-----------------------------------------
  plug M F âˆ£ Î¼ âˆ£ pc â€”â†’ plug N F âˆ£ Î¼â€²


plug (blame p) F âˆ£ Î¼ âˆ£ pc â€”â†’ blame p âˆ£ Î¼


       low âŸ¨ (stamp cÌ…â‚™ â„“) â¨¾ (gâ‚ â‹Ìƒ â„“ â‡’ gâ‚‚) â¨Ÿ cÌ… âŸ© â€”â†  pc
--------------------------------------------------------------  âŠ¢ cÌ…â‚™ : low â‡’ gâ‚  âŠ¢ cÌ… : gâ‚‚ â‡’ gâ‚ƒ
   { cÌ… } M âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™ âŸ© â€”â†’ â¦ƒ pc â¦„ M âŸª â„“ âŸ« âˆ£ Î¼


  low âŸ¨ (stamp cÌ…â‚™ â„“) â¨¾ (gâ‚ â‹Ìƒ â„“ â‡’ gâ‚‚) â¨Ÿ cÌ… âŸ© â€”â†  low âŸ¨ âŠ¥áµ– âŸ©
--------------------------------------------------------------  âŠ¢ cÌ…â‚™ : low â‡’ gâ‚  âŠ¢ cÌ… : gâ‚‚ â‡’ gâ‚ƒ
   { cÌ… } M âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™ âŸ© â€”â†’ blame p


              M âˆ£ Î¼ âˆ£ pcâ€² â€”â†’ N âˆ£ Î¼â€²
------------------------------------------------------------
â¦ƒ pcâ€² â¦„ M âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ pc  â€”â†’ â¦ƒ pcâ€² â¦„ N âŸª â„“ âŸ« âˆ£ Î¼â€²


â¦ƒ pcâ€² â¦„ blame p âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ pc â€”â†’ blame p


â¦ƒ _ â¦„ V âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ pc â€”â†’ stamp V â„“ âˆ£ Î¼


                c â€”â†  cáµ¢
--------------------------------------------
  Váµ£ âŸ¨ c âŸ© âˆ£ Î¼ | pc â€”â†’ Váµ£ âŸ¨ cáµ¢ âŸ© âˆ£ Î¼


            c â€”â†  (cáµ£ | âŠ¥áµ–)
--------------------------------------------
    Váµ£ âŸ¨ c âŸ© âˆ£ Î¼ | v_pc â€”â†’ blame p


k âŸ¨ id(Î¹) | id(â„“) âŸ© âˆ£ Î¼ âˆ£ pc â€”â†’ k âˆ£ Î¼


(Váµ£ âŸ¨ cáµ¢ âŸ©) âŸ¨ d âŸ© âˆ£ Î¼ âˆ£ pc â€”â†’ V âŸ¨ cáµ¢ â¨Ÿ d âŸ© âˆ£ Î¼


app (Æ› N) V A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ stamp pc â„“ â¦„ (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


app ((Æ› N) âŸ¨ dÌ… | c â†’ d | cÌ…â‚™ âŸ©) V A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ let V âŸ¨ c âŸ© in ({ dÌ… } (N âŸ¨ d âŸ©) âŸª âˆ¥ cÌ…â‚™ âˆ¥ âŸ«) âˆ£ Î¼


app! (Æ› N) V A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ { id(â‹†) } (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


app! ((Æ› N) âŸ¨ dÌ… | c â†’ d | cÌ…â‚™ âŸ©) V A B g âˆ£ Î¼ âˆ£ pc â€”â†’ let V âŸ¨ c âŸ© in ({ dÌ… } (N âŸ¨ d âŸ©) âŸª âˆ¥ cÌ…â‚™ âˆ¥ âŸ«) âˆ£ Î¼


if true A â„“ M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ stamp pc â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼


if (true âŸ¨ id(ğ”¹) | â†‘ âŸ©) A high M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ stamp pc high â¦„ M âŸª high âŸ« âˆ£ Î¼


if! true A â„“ M N âˆ£ Î¼ âˆ£ pc â€”â†’ { id(â‹†) } M âŸª â„“ âŸ« âˆ£ Î¼


if! (true âŸ¨ id(ğ”¹) | cÌ…â‚™ âŸ©) A g M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ id(â‹†) â¦„ M âŸª âˆ¥ cÌ…â‚™ âˆ¥ âŸ« âˆ£ Î¼


let V A N âˆ£ Î¼ âˆ£ pc â€”â†’ N[ V ] âˆ£ Î¼


refâŸ¦ â„“ âŸ§ T V âˆ£ Î¼ âˆ£ pc â€”â†’ addr n â„“ âˆ£ Î¼(â„“ â†¦ Î¼(â„“)(n â†¦ V))   , n is fresh


                         low âŸ¨ cÌ…â‚™ â¨¾ â‹† â‡’áµ– â„“ âŸ© â€”â†  pc
--------------------------------------------------------------------------------------
  ref?âŸ¦ â„“ âŸ§ T V p âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™ âŸ© â€”â†’ addr n â„“ âˆ£ Î¼(â„“ â†¦ Î¼(â„“)(n â†¦ V)) , n is fresh


                       low âŸ¨ cÌ…â‚™ â¨¾ â‹† â‡’áµ– â„“ âŸ© â€”â†  low âŸ¨ âŠ¥áµ– âŸ©
---------------------------------------------------------------------------------
                  ref?âŸ¦ â„“ âŸ§ T V p âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™ âŸ© â€”â†’ blame p


                          Î¼(â„“Ì‚)(n) = V
----------------------------------------------------------------
  ! (addr n â„“Ì‚) (T of â„“Ì‚) â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ pc â¦„ V âŸª â„“ âŸ« âˆ£ Î¼


                          Î¼(â„“Ì‚)(n) = V
----------------------------------------------------------------------------------------
! (addr n â„“Ì‚ âŸ¨ dÌ… | in: c; out: d | cÌ…â‚™ âŸ©) A g âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ pc â¦„ (V âŸ¨ d âŸ©) âŸª âˆ¥ cÌ…â‚™ âˆ¥ âŸ«


assign (addr n â„“Ì‚) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ v_pc â€”â†’ unit âˆ£ Î¼(â„“Ì‚ â†¦ Î¼(â„“Ì‚)(n â†¦ V))


       low âŸ¨ (stamp cÌ…â‚™â€² â„“) â¨¾ (â„“â€² â‹ â„“ â‡’ â„“Ì‚â€²) â¨Ÿ dÌ… âŸ© â€”â†  pc
----------------------------------------------------------------------------- âŠ¢ cÌ…â‚™â€² : low â‡’ â„“â€²  âŠ¢ dÌ… : â„“Ì‚â€² â‡’ â„“Ì‚
assign (addr n â„“Ì‚ âŸ¨ dÌ… | in: c; out: d | cÌ…â‚™ âŸ©) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™â€² âŸ© â€”â†’
       unit âˆ£ Î¼(â„“Ì‚ â†¦ Î¼(â„“Ì‚)(n â†¦ VâŸ¨câŸ©))


       low âŸ¨ (stamp cÌ…â‚™â€² â„“) â¨¾ (â„“â€² â‹ â„“ â‡’ â„“Ì‚â€²) â¨Ÿ dÌ… âŸ© â€”â†  low âŸ¨ âŠ¥áµ– âŸ©
----------------------------------------------------------------------------- âŠ¢ cÌ…â‚™â€² : low â‡’ â„“â€²  âŠ¢ dÌ… : â„“Ì‚â€² â‡’ â„“Ì‚
assign (addr n â„“Ì‚ âŸ¨ dÌ… | in: c; out: d | cÌ…â‚™ âŸ©) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ low âŸ¨ cÌ…â‚™â€² âŸ© â€”â†’
       blame p


        low âŸ¨ (stamp cÌ…â‚™â€² âˆ¥ cÌ…â‚™ âˆ¥) â¨¾ (g â‹Ìƒ âˆ¥ cÌ…â‚™ âˆ¥ â‡’ â‹†) â¨Ÿ dÌ… âŸ© â€”â†  pc
----------------------------------------------------------------------------  âŠ¢ cÌ…â‚™â€² : low â‡’ g  âŠ¢ dÌ… : â‹† â‡’ â„“Ì‚
assign? (addr n â„“Ì‚ âŸ¨ dÌ… | in: c; out: d | cÌ…â‚™ âŸ©) V T p âˆ£ Î¼ | low âŸ¨ cÌ…â‚™â€² âŸ© â€”â†’
        unit | Î¼(â„“Ì‚ â†¦ Î¼(â„“Ì‚)(n â†¦ VâŸ¨câŸ©))


        low âŸ¨ (stamp cÌ…â‚™â€² âˆ¥ cÌ…â‚™ âˆ¥) â¨¾ (g â‹Ìƒ âˆ¥ cÌ…â‚™ âˆ¥ â‡’ â‹†) â¨Ÿ dÌ… âŸ© â€”â†  low âŸ¨ âŠ¥áµ– âŸ©
----------------------------------------------------------------------------  âŠ¢ cÌ…â‚™â€² : low â‡’ g  âŠ¢ dÌ… : â‹† â‡’ â„“Ì‚
assign? (addr n â„“Ì‚ âŸ¨ dÌ… | in: c; out: d | cÌ…â‚™ âŸ©) V T p âˆ£ Î¼ | low âŸ¨ cÌ…â‚™â€² âŸ© â€”â†’
        blame p
