app (Æ› N) V â„“á¶œ A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ (â¦ƒ â„“á¶œ â¦„ (N[ V ])) âŸª â„“ âŸ« âˆ£ Î¼


          pc âŸ¨ pc â‡’ â„“á¶œ âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹
-----------------------------------------------------------
app ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V â„“á¶œ A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’
    â¦ƒ ğ“‹ â¦„ (let (V âŸ¨ c âŸ©) in N âŸ¨ d âŸ©) âŸª âˆ¥ câ‚— âˆ¥ âŸ« âˆ£ Î¼


       stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© â€”â†  ğ“‹â€²
----------------------------------------------------------------------------
app! (Æ› N) V A B â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


       stamp ğ“‹ âˆ¥ câ‚— âˆ¥ âŸ¨ ty(ğ“‹) â‹Ìƒ g â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹â€²
-----------------------------------------------------------
app! ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V A B g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’
    (â¦ƒ ğ“‹â€² â¦„ let (V âŸ¨ c âŸ©) in (N âŸ¨ stamp d câ‚— âŸ©)) âˆ£ Î¼


if true A â„“ M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼


if (true âŸ¨ id(ğ”¹) | â†‘ âŸ©) A high M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ high â¦„ M âŸª high âŸ« âˆ£ Î¼


if! true A â„“ M N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ stamp ğ“‹ â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼

Note: ğ“‹ must be of form â„“á¶œ âŸ¨ â„“á¶œ ! âŸ© for some â„“á¶œ


      stamp ğ“‹ âˆ¥ câ‚— âˆ¥ âŸ¨ ty(ğ“‹) â‹Ìƒ g â‡’ â‹† âŸ© â€”â†  ğ“‹â€²
--------------------------------------------------------------------------
if! (true âŸ¨ id(ğ”¹) | câ‚— âŸ©) A g M N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ M âŸª âˆ¥ câ‚— âˆ¥ âŸ« âˆ£ Î¼


let V A N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ N[ V ] âˆ£ Î¼


refâŸ¦ â„“ âŸ§ T M âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ refâœ“âŸ¦ â„“ âŸ§ T M âˆ£ Î¼


  â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  ğ“‹â€²
---------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T M p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ refâœ“âŸ¦ â„“ âŸ§ T M âˆ£ Î¼


  â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  err p
---------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T M p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ blame p âˆ£ Î¼


refâœ“âŸ¦ â„“ âŸ§ T V âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ addr n â„“ âˆ£ (n â„“ â†¦ V) âˆ· Î¼     , n is fresh


                   Î¼(n â„“Ì‚) = V
---------------------------------------------------
! (addr n â„“Ì‚) (T of â„“Ì‚) â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ V âŸª â„“ âŸ« âˆ£ Î¼


                   Î¼(n â„“Ì‚) = V
----------------------------------------------------------------------------------------
! (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) A g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ V âŸª âˆ¥ câ‚— âˆ¥ âŸ« âŸ¨ stamp d câ‚— âŸ©


assign L M T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ assignâœ“ L M T â„“Ì‚ â„“ âˆ£ Î¼


                                â„“ = âˆ¥ câ‚— âˆ¥
                  stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹â€²
----------------------------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) M T p âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ assignâœ“ ...

                                â„“ = âˆ¥ câ‚— âˆ¥
                  stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  err p
----------------------------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) M T p âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p


assignâœ“ (addr n â„“Ì‚) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ unit âˆ£ Î¼(n â„“Ì‚) = V


assignâœ“ (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ unit âˆ£ Î¼(n â„“Ì‚) = (V âŸ¨ c âŸ©)
