V ::= k | Æ› N | addr n â„“Ì‚
    | k âŸ¨ id(Î¹) | câ‚—â„“Î¹ âŸ©
    | Æ› N âŸ¨ câ‚—áµ–á¶œ | c â†’ d | câ‚—â„“ âŸ©
    | addr n â„“Ì‚ âŸ¨ câ‚—Ì‚ | in: c; out: d | câ‚—â„“ âŸ©

F ::= app â–¡ M â„“á¶œ A B â„“ | app V â–¡ â„“á¶œ A B â„“
    | app! â–¡ M A B g | app! V â–¡ A B g
    | if â–¡ A â„“ M N | if! â–¡ A g M N
    | let â–¡ N | refâœ“âŸ¦ â„“ âŸ§ â–¡ | ! â–¡
    | assign? â–¡ M T p | assignâœ“ â–¡ M T â„“Ì‚ â„“ | assignâœ“ V â–¡ M T â„“Ì‚ â„“
    | â–¡ âŸ¨ c âŸ©

       M âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ N âˆ£ Î¼â€²
---------------------------------------
plug M F âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ plug N F âˆ£ Î¼â€²


plug (blame p) F âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p âˆ£ Î¼


app (Æ› N) V â„“á¶œ A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ â„“á¶œ â¦„ (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


           pc â‹ â„“ âŸ¨ pc â‹ â„“ â‡’ â„“á¶œ âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹
-----------------------------------------------------------
app ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V â„“á¶œ A B â„“ âˆ£ Î¼ âˆ£ pc â€”â†’
    let (V âŸ¨ c âŸ©) in (â¦ƒ ğ“‹ â¦„ (N âŸ¨ d âŸ©) âŸª â„“ âŸ«) âˆ£ Î¼


         stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© â€”â†  ğ“‹â€²
------------------------------------------------------------
app! (Æ› N) V A B â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ (N[ V ]) âŸª â„“ âŸ« âˆ£ Î¼


                      â„“ = âˆ¥ câ‚— âˆ¥
       stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹â€²
-----------------------------------------------------------
app! ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V A B g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’
    let (V âŸ¨ c âŸ©) in (â¦ƒ ğ“‹â€² â¦„ (N âŸ¨ d âŸ©) âŸª â„“ âŸ«) âˆ£ Î¼

                      â„“ = âˆ¥ câ‚— âˆ¥
       stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  err p
-----------------------------------------------------------------
app! ((Æ› N) âŸ¨ dâ‚— | c â†’ d | câ‚— âŸ©) V A B g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p

Note: `dâ‚—` may contain a projection


if true A â„“ M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ pc â‹ â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼

if (true âŸ¨ id(ğ”¹) | â†‘ âŸ©) A high M N âˆ£ Î¼ âˆ£ pc â€”â†’ â¦ƒ high â¦„ M âŸª high âŸ« âˆ£ Î¼


if! true A â„“ M N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ stamp ğ“‹ â„“ â¦„ M âŸª â„“ âŸ« âˆ£ Î¼

Note: from typing, ğ“‹ must be `â„“á¶œ âŸ¨ â„“á¶œ ! âŸ©` for some â„“á¶œ


                 â„“ = âˆ¥ câ‚— âˆ¥
      stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© â€”â†  ğ“‹â€²
--------------------------------------------------------------------
if! (true âŸ¨ id(ğ”¹) | câ‚— âŸ©) A g M N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ M âŸª â„“ âŸ« âˆ£ Î¼


let V A N âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ N[ V ] âˆ£ Î¼


refâŸ¦ â„“ âŸ§ T M âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ refâœ“âŸ¦ â„“ âŸ§ T M âˆ£ Î¼


  â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  ğ“‹â€²
---------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T M p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ refâœ“âŸ¦ â„“ âŸ§ T M âˆ£ Î¼


  â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  err p
-----------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T M p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ blame p âˆ£ Î¼


refâœ“âŸ¦ â„“ âŸ§ T V âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ addr n â„“ âˆ£ (n â„“ â†¦ V) âˆ· Î¼   , n is fresh

* Alternative rules for reference creation:

refâŸ¦ â„“ âŸ§ T V âˆ£ Î¼ âˆ£ pc â€”â†’ addr n â„“ âˆ£ (n â„“ â†¦ V) âˆ· Î¼   , n is fresh

                    â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  ğ“‹â€²
---------------------------------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T V p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ addr n â„“ âˆ£ (n â„“ â†¦ V) âˆ· Î¼   , n is fresh

Note: implies that â„“â€² â‰¼ â„“

                    â„“â€² âŸ¨ â„“â€² ! âŸ© âŸ¨ â‹† â‡’áµ– â„“ âŸ© â€”â†  err p
---------------------------------------------------------------------------------
ref?âŸ¦ â„“ âŸ§ T V p âˆ£ Î¼ âˆ£ â„“â€² âŸ¨ â„“â€² ! âŸ© â€”â†’ blame p âˆ£ Î¼   , n is fresh


                   Î¼(n â„“Ì‚) = V
---------------------------------------------------
! (addr n â„“Ì‚) (T of â„“Ì‚) â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ V âŸª â„“ âŸ« âˆ£ Î¼


                   Î¼(n â„“Ì‚) = V
----------------------------------------------------------------------------------------
! (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) A g âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ V âŸ¨ d âŸ© âŸª âˆ¥ câ‚— âˆ¥ âŸ«


assign L M T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ assignâœ“ L M T â„“Ì‚ â„“ âˆ£ Î¼


                                â„“ = âˆ¥ câ‚— âˆ¥
                  stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  ğ“‹â€²
--------------------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) M T p âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ assignâœ“ ...

                                â„“ = âˆ¥ câ‚— âˆ¥
                  stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†  err p
------------------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) M T p âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p


assignâœ“ (addr n â„“Ì‚) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ unit âˆ£ Î¼(n â„“Ì‚) = V


assignâœ“ (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’
        unit âˆ£ Î¼(n â„“Ì‚) = (V âŸ¨ c âŸ©)

* Alternative rules for assignment:

assign (addr n â„“Ì‚) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ unit âˆ£ Î¼(n â„“Ì‚) = V

assign (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T â„“Ì‚ â„“ âˆ£ Î¼ âˆ£ pc â€”â†’ unit âˆ£ Î¼(n â„“Ì‚) = V

Note: in this case dâ‚— must be id(â„“Ì‚). from typing we know pc â‹ â„“ â‰¼ â„“Ì‚, which
implies that the assignment is safe

                         â„“ = âˆ¥ câ‚— âˆ¥
          stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†’ ğ“‹â€²
-----------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T p âˆ£ Î¼ | ğ“‹ â€”â†’
        unit | Î¼(n â„“Ì‚) = V

âŠ¢ dâ‚— : â‹† â‡’ â„“Ì‚

                         â„“ = âˆ¥ câ‚— âˆ¥
          stamp ğ“‹ â„“ âŸ¨ ty(ğ“‹) â‹Ìƒ â„“ â‡’ â‹† âŸ© âŸ¨ dâ‚— âŸ© â€”â†’ err p
----------------------------------------------------------------------------
assign? (addr n â„“Ì‚ âŸ¨ dâ‚— | in: c; out: d | câ‚— âŸ©) V T p âˆ£ Î¼ | ğ“‹ â€”â†’ blame p

Note: `dâ‚—` is projecting, where the blame label `p` comes from


V âŸ¨ c âŸ© âŸ¨ d âŸ© âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ V âŸ¨ c â¨Ÿ d âŸ© âˆ£ Î¼


V âŸ¨ cáµ£ | âŠ¥áµ– âŸ© âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p âˆ£ Î¼


       M âˆ£ Î¼ âˆ£ ğ“‹â€² â€”â†’ N âˆ£ Î¼â€²
------------------------------------------
â¦ƒ ğ“‹â€² â¦„ M âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ â¦ƒ ğ“‹â€² â¦„ N âˆ£ Î¼â€²

â¦ƒ ğ“‹â€² â¦„ blame p âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p âˆ£ Î¼


V âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ stamp V â„“ âˆ£ Î¼

(blame p) âŸª â„“ âŸ« âˆ£ Î¼ âˆ£ ğ“‹ â€”â†’ blame p âˆ£ Î¼
